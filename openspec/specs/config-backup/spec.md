# config-backup Specification

## Purpose
TBD - created by archiving change enhance-rime-recipe-market. Update Purpose after archive.
## Requirements
### Requirement: 配置自动备份

插件MUST在每次修改配置前自动创建备份,以防止配置错误导致的问题。

#### Scenario: 安装配方前自动备份

- **当** 用户安装配方时
- **则** 系统MUST在执行安装前创建配置备份
- **并且** 备份描述MUST包含操作类型和配方名称 (如 "安装前备份 - 雾凇拼音")
- **并且** 备份MUST在配置修改前完成
- **并且** 如果备份失败,安装操作MUST中止

#### Scenario: 卸载配方前自动备份

- **当** 用户卸载配方时
- **则** 系统MUST在执行卸载前创建配置备份
- **并且** 备份描述MUST包含操作类型和配方名称 (如 "卸载前备份 - 朙月拼音")
- **并且** 备份MUST在配置修改前完成

#### Scenario: 启用/禁用方案前自动备份

- **当** 用户启用或禁用输入方案时
- **则** 系统MUST在执行修改前创建配置备份
- **并且** 备份描述MUST包含操作类型和方案ID (如 "启用方案前备份 - luna_pinyin")

---

### Requirement: 备份保留策略

插件MUST实施自动备份清理策略,以避免占用过多磁盘空间。

#### Scenario: 限制备份数量

- **当** 备份数量达到10份时
- **则** 创建新备份后MUST删除最旧的备份
- **并且** 特殊标记为"长期保存"的备份MUST不计入限制
- **并且** 特殊标记为"长期保存"的备份MUST不会被自动删除

#### Scenario: 清理过期备份

- **当** 备份超过3个月时
- **则** 系统MUST在创建新备份后自动删除过期备份
- **并且** 特殊标记为"长期保存"的备份MUST不受时间限制
- **并且** 删除前MUST记录日志

#### Scenario: 备份清理触发时机

- **当** 创建新备份后
- **则** 系统MUST立即执行备份清理
- **并且** 清理操作MUST在后台异步执行
- **并且** 清理结果MUST记录到日志

---

### Requirement: 备份元数据

每个备份MUST有完整的元数据,用于识别和管理。

#### Scenario: 创建备份元数据文件

- **当** 创建备份时
- **则** MUST在备份目录中创建 `backup-metadata.json` 文件
- **并且** 元数据MUST包含:
  - 备份ID (时间戳)
  - 备份名称
  - 创建时间 (Unix timestamp)
  - 备份大小 (bytes)
  - 是否为长期备份 (boolean)
  - 备份描述

#### Scenario: 读取备份元数据

- **当** 系统扫描备份目录时
- **则** MUST读取每个备份的元数据文件
- **并且** 如果元数据文件缺失或损坏,备份MUST标记为"无效"
- **并且** 无效的备份MUST不显示在备份列表中

---

### Requirement: 手动备份管理

用户MUST能够手动创建备份和恢复备份。

#### Scenario: 手动创建备份

- **当** 用户点击"创建备份"按钮时
- **则** 系统MUST显示备份描述输入对话框
- **并且** 用户可以输入自定义描述
- **并且** 用户可以选择是否标记为长期保存
- **并且** 创建成功后MUST显示通知

#### Scenario: 恢复备份

- **当** 用户选择恢复备份时
- **则** 系统MUST显示确认对话框
- **并且** 对话框MUST显示备份信息和警告
- **并且** 用户确认后MUST先创建当前配置的备份
- **并且** 然后MUST恢复备份文件
- **并且** 恢复完成后MUST重新部署 Rime

#### Scenario: 删除备份

- **当** 用户选择删除备份时
- **则** 系统MUST显示确认对话框
- **并且** 对话框MUST警告删除操作不可恢复
- **并且** 用户确认后MUST删除备份目录
- **并且** 删除后MUST更新备份列表

#### Scenario: 切换长期备份标记

- **当** 用户将备份标记为长期保存时
- **则** 备份元数据中的 `isPermanent` MUST设置为 true
- **并且** 备份UI中MUST显示特殊标记 (如 ⭐)
- **并且** 该备份不再受自动清理限制

---

### Requirement: 备份列表UI

插件MUST提供清晰的备份管理界面。

#### Scenario: 显示备份列表

- **当** 用户访问备份管理页面时
- **则** MUST显示所有有效备份
- **并且** 每个备份MUST显示:
  - 备份ID/时间戳
  - 备份描述
  - 创建时间 (格式化的易读格式)
  - 备份大小
  - 是否为长期备份
- **并且** 备份MUST按创建时间倒序排列

#### Scenario: 区分长期备份

- **当** 显示备份列表时
- **则** 长期备份MUST显示特殊图标 (⭐)
- **并且** 长期备份MUST有视觉上的区分
- **并且** 长期备份的操作按钮中MUST显示"取消长期"而非"设为长期"

#### Scenario: 显示备份操作按钮

- **当** 显示备份卡片时
- **则** MUST提供以下操作按钮:
  - "恢复" - 恢复该备份
  - "删除" - 删除该备份
  - "设为长期"/"取消长期" - 切换长期保存标记
- **并且** 按钮MUST根据备份状态动态显示

---

### Requirement: 备份文件命名规范

备份文件和目录MUST遵循一致的命名规范。

#### Scenario: 普通备份命名

- **当** 创建普通备份时
- **则** 备份目录名MUST使用格式: `backup-YYYY-MM-DD-HH-mm-ss`
- **并且** 时间戳MUST使用备份创建时的本地时间
- **例如**: `backup-2026-01-13-10-30-00`

#### Scenario: 长期备份命名

- **当** 创建长期备份时
- **则** 备份目录名MUST使用格式: `backup-permanent-{UnixTimestamp}`
- **并且** UnixTimestamp MUST是毫秒级时间戳
- **例如**: `backup-permanent-1736740800000`

#### Scenario: 备份目录结构

- **当** 创建备份时
- **则** 备份目录MUST包含:
  - 所有配置文件的副本
  - `backup-metadata.json` 元数据文件
- **并且** 备份目录MUST位于: `${RIME_DIR}/backups/`

---

