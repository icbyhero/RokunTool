# 插件权限请求系统 - 测试指南

## 测试环境准备

1. ✅ 确保应用已正常启动
2. ✅ 按 `F12` 打开开发者工具,查看控制台是否有错误
3. ✅ 确认插件列表中有至少 2 个插件(微信分身管理、Rime 配置管理)

---

## 第一阶段: 权限管理页面 UI 测试

### 测试步骤

#### 1. 打开插件详情页
- [ ] 在插件列表中找到 "微信分身管理" 或 "Rime 配置管理"
- [ ] 点击插件名称或"打开插件"按钮
- [ ] 确认进入插件详情页面

**预期结果:** 插件详情页面正常显示,包含 4 个标签页(概览、权限、配置、日志)

#### 2. 查看"权限"标签页
- [ ] 点击顶部导航的"权限"标签
- [ ] 查看权限列表是否显示

**预期结果:**
- 显示 "权限管理" 标题
- 显示 "管理此插件的 X 个权限" 描述
- 右上角有"查看历史"按钮
- 权限列表中每个权限包含:
  - Emoji 图标
  - 权限名称(如"文件写入权限")
  - 权限描述
  - 状态标签(未询问/已授权/已拒绝)
  - 基础/敏感 分类标签

#### 3. 检查权限状态
- [ ] 查看所有权限的状态标签
- [ ] 确认状态显示为"未询问"
- [ ] 检查基础权限和敏感权限的分类

**预期结果:**
- 所有权限状态都显示为"未询问"(灰色标签,带时钟图标)
- 基础权限显示"基础"标签(灰色)
- 敏感权限显示"敏感"标签(黄色)
- 每个敏感权限右侧有黄色警告三角形图标

#### 4. 测试"查看历史"按钮
- [ ] 点击右上角的"查看历史"按钮
- [ ] 查看是否展开历史记录区域
- [ ] 再次点击"隐藏历史"按钮
- [ ] 确认历史记录区域收起

**预期结果:**
- 点击"查看历史"后,显示"权限变更历史"卡片
- 显示"暂无历史记录"消息(因为是首次测试)
- 按钮文字变为"隐藏历史"
- 再次点击后历史记录区域收起

#### 5. 测试其他插件
- [ ] 返回插件列表
- [ ] 打开另一个插件的详情页
- [ ] 查看"权限"标签页
- [ ] 确认权限列表正常显示

**预期结果:** 不同插件的权限列表应正确显示其所需的权限

---

## 第二阶段: 权限管理功能测试

### 1. 测试权限状态加载
- [ ] 打开任意插件的详情页
- [ ] 切换到"权限"标签
- [ ] 观察是否显示"加载权限状态..."加载动画
- [ ] 等待加载完成

**预期结果:**
- 首次进入显示加载动画
- 1-2 秒后加载完成,显示权限列表
- 所有权限状态为"未询问"

### 2. 测试权限撤销功能(需先有已授权的权限)
- [ ] **前置条件**: 需要至少有一个权限状态为"已授权"
- [ ] 找到状态为"已授权"的权限
- [ ] 点击"撤销"按钮
- [ ] 在确认对话框中点击"确定"
- [ ] 查看权限状态是否变为"已拒绝"

**预期结果:**
- 弹出确认对话框: "确定要撤销 fs:write 权限吗?"
- 点击确定后,权限状态变为"已拒绝"(红色标签)
- "撤销"按钮消失
- 显示"拒绝后插件将无法使用此权限"提示

---

## 第三阶段: 权限请求对话框测试(需要插件适配后)

### 准备工作

**需要先完成插件适配** - 修改微信分身插件以触发权限请求

### 测试步骤

#### 1. 触发权限请求
- [ ] 打开"微信分身管理"插件页面
- [ ] 点击"创建微信分身"按钮
- [ ] 输入分身名称(如"微信2")
- [ ] 点击"确定创建"按钮

**预期结果:**
- 弹出权限请求对话框
- 对话框包含以下信息:
  - 标题: "微信分身管理 请求权限"
  - 权限图标: 📁
  - 权限名称: "文件写入权限"
  - 权限描述: "允许插件在指定位置创建和修改文件"
  - 操作上下文:
    - 操作: 复制微信应用
    - 目标: /Applications/WeChat.app
  - 黄色安全提示卡片,显示风险警告
  - 三个按钮: 取消 / 拒绝 / 允许

#### 2. 测试"取消"按钮
- [ ] 在权限请求对话框中点击"取消"按钮
- [ ] 确认对话框关闭
- [ ] 检查微信分身是否未创建

**预期结果:**
- 对话框立即关闭
- 不执行任何操作
- 插件状态保持不变

#### 3. 测试"拒绝"按钮
- [ ] 再次触发权限请求(重复步骤 1)
- [ ] 点击"拒绝"按钮
- [ ] 确认对话框关闭
- [ ] 打开插件详情页
- [ ] 切换到"权限"标签
- [ ] 查看 fs:write 权限状态

**预期结果:**
- 对话框关闭
- fs:write 权限状态变为"已拒绝"
- 显示红色"已拒绝"标签
- 显示"拒绝后插件将无法使用此权限"提示
- 微信分身未创建

#### 4. 测试"允许"按钮
- [ ] 再次触发权限请求
- [ ] 点击"允许"按钮
- [ ] 确认对话框关闭
- [ ] 查看微信分身是否创建成功
- [ ] 打开插件详情页
- [ ] 切换到"权限"标签
- [ ] 查看 fs:write 权限状态

**预期结果:**
- 对话框关闭
- fs:write 权限状态变为"已授权"(绿色标签)
- 显示"撤销"按钮
- 微信分身创建成功

#### 5. 测试 ESC 键关闭
- [ ] 触发权限请求
- [ ] 按 `ESC` 键
- [ ] 确认对话框关闭

**预期结果:** 对话框立即关闭,等同于点击"取消"

#### 6. 测试权限历史记录
- [ ] 完成步骤 4(授权权限)
- [ ] 打开插件详情页
- [ ] 切换到"权限"标签
- [ ] 点击"查看历史"按钮

**预期结果:**
- 显示权限变更历史记录
- 包含以下信息:
  - 权限: fs:write
  - 状态: 已授予(绿色标签)
  - 来源: user(蓝色标签)
  - 操作: 复制微信应用 (/Applications/WeChat.app)
  - 时间戳: 当前时间

---

## 第四阶段: 权限持久化测试

### 测试步骤

#### 1. 授权权限
- [ ] 按照第三阶段步骤 4,授权 fs:write 权限
- [ ] 确认权限状态为"已授权"

#### 2. 重启应用
- [ ] 完全关闭应用(不仅仅是关闭窗口)
- [ ] 重新启动应用
- [ ] 打开同一个插件的详情页
- [ ] 切换到"权限"标签
- [ ] 查看 fs:write 权限状态

**预期结果:**
- 权限状态保持为"已授权"
- 不需要重新授权
- 权限历史记录仍然保留

---

## 第五阶段: 边界情况测试

### 1. 测试网络超时
- [ ] 修改权限管理器的超时时间为 1 秒
- [ ] 触发权限请求
- [ ] 等待 1 秒钟不点击任何按钮

**预期结果:**
- 显示超时错误
- 对话框自动关闭
- 插件收到权限拒绝响应

### 2. 测试多个权限请求
- [ ] 快速连续创建多个微信分身
- [ ] 观察是否只显示一个权限请求对话框
- [ ] 确认后续请求等待前一个完成

**预期结果:**
- 同一时间只显示一个权限请求对话框
- 其他请求等待队列中

### 3. 测试基础权限自动授予
- [ ] 找一个只需要基础权限的插件(如果有)
- [ ] 触发需要基础权限的操作

**预期结果:**
- 不弹出权限请求对话框
- 权限自动授予
- 操作正常执行

---

## 常见问题检查清单

### 控制台错误检查

打开开发者工具(F12),检查 Console 标签页:

- [ ] 没有 TypeScript 类型错误
- [ ] 没有 React 渲染错误
- [ ] 没有 IPC 通信错误
- [ ] 没有权限系统相关错误

### UI 显示检查

- [ ] 所有图标正常显示
- [ ] 权限卡片布局正常
- [ ] 按钮样式正常
- [ ] 深色模式下显示正常
- [ ] 响应式布局正常(调整窗口大小)

### 功能检查

- [ ] 权限状态正确显示
- [ ] 历史记录正确保存
- [ ] 撤销功能正常工作
- [ ] 权限请求对话框正常弹出
- [ ] 持久化存储正常工作

---

## 测试结果记录表

请将测试结果记录在下方:

### 阶段一: UI 测试
- [ ] 通过 / 失败 - 权限管理页面显示
- [ ] 通过 / 失败 - 权限列表显示
- [ ] 通过 / 失败 - 权限状态显示
- [ ] 通过 / 失败 - 历史记录切换
- [ ] 通过 / 失败 - 多插件切换

**备注:** _______________________________________

### 阶段二: 功能测试
- [ ] 通过 / 失败 - 权限加载动画
- [ ] 通过 / 失败 - 权限撤销功能

**备注:** _______________________________________

### 阶段三: 权限请求对话框
- [ ] 通过 / 失败 - 对话框显示
- [ ] 通过 / 失败 - 取消按钮
- [ ] 通过 / 失败 - 拒绝按钮
- [ ] 通过 / 失败 - 允许按钮
- [ ] 通过 / 失利 - ESC 键关闭
- [ ] 通过 / 失败 - 历史记录更新

**备注:** _______________________________________

### 阶段四: 持久化测试
- [ ] 通过 / 失败 - 重启后权限保持

**备注:** _______________________________________

### 阶段五: 边界情况
- [ ] 通过 / 失败 - 超时处理
- [ ] 通过 / 失败 - 多请求排队
- [ ] 通过 / 失败 - 基础权限自动授予

**备注:** _______________________________________

---

## 发现的问题记录

请记录测试中发现的所有问题:

### 问题 1
**描述:**
_______________________________________
**严重程度:** 🔴 严重 / 🟡 中等 / 🟢 轻微
**复现步骤:**
1. ___________________________________
2. ___________________________________
3. ___________________________________

### 问题 2
**描述:**
_______________________________________
**严重程度:** 🔴 严重 / 🟡 中等 / 🟢 轻微
**复现步骤:**
1. ___________________________________
2. ___________________________________
3. ___________________________________

### 问题 3
**描述:**
_______________________________________
**严重程度:** 🔴 严重 / 🟡 中等 / 🟢 轻微
**复现步骤:**
1. ___________________________________
2. ___________________________________
3. ___________________________________

---

## 整体评价

### 优点
1. ___________________________________
2. ___________________________________
3. ___________________________________

### 需要改进的地方
1. ___________________________________
2. ___________________________________
3. ___________________________________

### 其他建议
1. ___________________________________
2. ___________________________________
3. ___________________________________

---

**测试人员:** _______________
**测试日期:** _______________
**测试环境:** macOS / Windows / Linux
**应用版本:** _______________
