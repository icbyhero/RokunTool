# 插件权限请求系统

## 概述

为 RokunTool 插件系统添加动态权限请求功能,允许插件在运行时请求敏感权限,用户提供显式授权后才能执行相应操作。

## 背景和动机

### 当前问题

微信分身插件在创建实例时失败,错误信息:
```
Command failed: cp -R "/Applications/WeChat.app" "/Applications/WeChat2.app"
cp: /Applications/WeChat2.app/WeChat.app: Permission denied
```

**根本原因**:
1. 插件在 `package.json` 中声明了 `fs:write` 和 `process:exec` 权限
2. 但这些权限在插件安装时就被自动授予,没有用户确认流程
3. macOS 系统级别的权限(如写入 `/Applications` 目录)需要额外的用户授权
4. 当前系统缺少运行时权限请求机制

### 用户需求

1. **渐进式权限请求**: 基础权限安装时授予,敏感权限使用时请求
2. **清晰的 UI 反馈**: 通过模态对话框展示权限请求
3. **权限管理**: 用户可以在设置页面查看和撤销已授予的权限
4. **安全的默认配置**: 敏感操作需要明确的用户同意

## 目标

### 主要目标

1. 实现运行时权限请求机制
2. 提供友好的权限请求 UI
3. 支持权限状态的持久化存储
4. 在插件设置页面提供权限管理界面

### 非目标

1. 修改现有的插件元数据格式(向后兼容)
2. 实现细粒度的权限级别(如只读/读写子目录)
3. 支持权限的时间限制(如一次性授权)

## 受影响的系统

1. **插件系统** (Plugin System)
   - 权限检查器增强
   - 权限存储机制

2. **IPC 层** (Inter-Process Communication)
   - 新增权限请求通信通道
   - 权限状态查询 API

3. **渲染进程 UI** (Renderer Process)
   - 权限请求对话框组件
   - 插件设置页面增强

## 解决方案概述

### 权限分类

**基础权限** (安装时自动授予):
- `fs:read` - 读取文件
- `config:read` - 读取配置
- `notification:show` - 显示通知

**敏感权限** (使用时请求):
- `fs:write` - 写入文件
- `process:spawn` - 启动进程
- `process:exec` - 执行命令
- `shell:execute` - 执行 Shell 命令
- `process:kill` - 终止进程
- `network:http` - HTTP 请求

### 权限请求流程

```
1. 插件调用需要权限的 API
   ↓
2. 系统检查权限状态
   ├─ 已授予 → 执行操作
   ├─ 已拒绝 → 返回权限错误
   └─ 未询问 → 触发权限请求
        ↓
3. 显示权限请求对话框
        ↓
4. 用户选择
   ├─ 允许 → 存储权限状态 → 执行操作
   ├─ 拒绝 → 存储拒绝状态 → 返回错误
   └─ 取消 → 返回错误(不存储状态)
```

### UI 组件

1. **权限请求对话框**
   - 显示插件名称和图标
   - 说明请求的权限及原因
   - 提供"允许"、"拒绝"、"取消"三个选项

2. **插件权限管理页面**
   - 列出所有已安装的插件
   - 显示每个插件已授予的权限
   - 允许用户撤销权限

## 成功标准

1. 微信分身插件能够成功请求并获得 `/Applications` 目录的写入权限
2. 用户能够清楚地看到插件请求的权限及原因
3. 用户可以在设置页面管理插件权限
4. 权限状态在应用重启后保持
5. 现有插件继续正常工作(向后兼容)

## 风险和限制

### 风险

1. **用户体验影响**: 频繁的权限弹窗可能打扰用户
   - **缓解措施**: 同一权限只请求一次,永久记录用户选择

2. **兼容性问题**: 旧版插件可能不适应新的权限系统
   - **缓解措施**: 保持向后兼容,基础权限自动授予

3. **安全风险**: 用户可能盲目授予所有权限
   - **缓解措施**: 在权限请求对话框中显示详细说明和风险提示

### 限制

1. 系统级权限(如 macOS 的安全偏好设置)无法通过此系统管理
2. 权限撤销不会立即终止正在执行的操作

## 未来增强

1. 权限组 - 一次请求多个相关权限
2. 临时权限 - 仅在当前会话有效
3. 权限审计日志 - 记录权限使用情况
4. 权限策略 - 管理员预设的权限规则
