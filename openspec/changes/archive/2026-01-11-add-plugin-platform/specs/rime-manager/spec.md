# 东风破(Rime配置管理器)插件规格说明

## ADDED Requirements

### Requirement: Rime环境检测
插件MUST能够自动检测系统中Rime输入法的安装位置和配置。

#### Scenario: 检测Rime安装
- **WHEN** 插件被加载
- **THEN** 插件应扫描Rime用户目录:
  - macOS: `~/Library/Rime` 或 `~/.local/share/fcitx5/rime` (fcitx5-rime)
  - Windows: `%APPDATA%\Rime`
  - Linux: `~/.local/share/fcitx5/rime` 或 `~/.config/ibus/rime`
- **AND** 应显示检测到的Rime类型(ibus/fcitx5/fcitx4/Rime默认)
- **AND** 如果未找到Rime,应显示"未安装"状态和安装指南

#### Scenario: 检测Rime配置文件
- **WHEN** Rime目录被检测到
- **THEN** 应读取并解析以下配置文件:
  - `default.custom.yaml`: 默认配置
  - `installation.yaml`: 已安装的方案
  - `user.yaml`: 用户配置
  - `*.schema.yaml`: 用户自定义方案
- **AND** 应验证YAML语法正确性
- **AND** 如果配置文件损坏,应显示错误提示和修复建议

#### Scenario: 检测Plum组件
- **WHEN** 检测Rime环境
- **THEN** 应检查是否安装了Plum(rime/plum)
- **AND** 应显示Plum安装状态(已安装/未安装)
- **AND** 如果未安装,应提供一键安装Plum的功能

### Requirement: 输入方案浏览和管理
插件MUST提供直观的界面来浏览、安装和卸载Rime输入方案。

#### Scenario: 显示已安装方案
- **WHEN** 用户打开方案管理页面
- **THEN** 应列出所有已安装的输入方案
- **AND** 每个方案应显示:
  - 方案名称(中英文)
  - 方案ID(schema_id)
  - 方案简介
  - 作者信息
  - 最后更新时间
  - 是否启用(在default.custom.yaml中)
- **AND** 应支持搜索和筛选方案

#### Scenario: 浏览可用方案
- **WHEN** 用户切换到"方案市场"标签
- **THEN** 应显示可供安装的方案列表
- **AND** 方案应分类显示:
  - 官方方案(来自rime/rime-prelude, rime/rime-essay等)
  - 流行方案(基于下载量或推荐)
  - 用户自定义方案
- **AND** 每个方案应显示:
  - 方案名称和简介
  - 星级评分(如有)
  - 安装数量(如有)
  - 标签(如"简体"、"繁体"、"拼音"、"五笔")
- **AND** 应支持按标签筛选和关键词搜索

#### Scenario: 安装方案
- **WHEN** 用户选择一个方案并点击"安装"
- **THEN** 应显示方案详情对话框,包括:
  - 方案完整描述
  - 依赖的其他方案
  - 所需的字典文件
  - 文件大小估计
- **AND** 用户确认后,应:
  1. 调用Plum下载方案文件
  2. 下载所需的字典文件
  3. 安装到Rime用户目录
  4. 自动部署(调用rime_deployer)
  5. 显示安装进度
- **AND** 安装成功后应显示成功提示

#### Scenario: 批量安装方案
- **WHEN** 用户选择多个方案并点击"批量安装"
- **THEN** 应显示确认对话框,列出所有待安装方案
- **AND** 应解析方案依赖关系,按正确顺序安装
- **AND** 应显示总体进度和当前安装的方案
- **AND** 如果某个方案安装失败,应继续安装其他方案
- **AND** 完成后应显示详细报告

#### Scenario: 卸载方案
- **WHEN** 用户选择一个已安装方案并点击"卸载"
- **THEN** 应显示确认对话框
- **AND** 应警告:卸载将删除该方案的所有配置和字典文件
- **AND** 应检查是否有其他方案依赖该方案
- **AND** 如果有依赖,应提示用户同时卸载依赖方案
- **AND** 确认后应删除相关文件并重新部署

#### Scenario: 启用/禁用方案
- **WHEN** 用户切换方案的启用状态
- **THEN** 应修改`default.custom.yaml`中的方案列表
- **AND** 应自动调用rime_deployer重新部署
- **AND** 应显示操作结果

### Requirement: Plum集成
插件MUST集成Rime Plum功能,提供图形化的方案和字典管理。

#### Scenario: Plum安装管理
- **WHEN** 用户点击"安装Plum"按钮
- **THEN** 应检查Git是否可用
- **AND** 应执行Plum安装脚本:
  - macOS/Linux: `bash -c "$(curl -fsSL https://git.io/rime-install)"`
  - Windows: 提供PowerShell安装脚本
- **AND** 应显示安装进度
- **AND** 安装完成后应验证Plum可用性

#### Scenario: 使用Plum安装方案
- **WHEN** 用户通过Plum安装方案
- **THEN** 应执行`bash rime-install <方案名>`命令
- **AND** 应捕获并显示命令输出
- **AND** 应监控下载进度
- **AND** 安装完成后应自动部署

#### Scenario: 使用Plum更新方案
- **WHEN** 用户点击"更新所有方案"
- **THEN** 应对每个已安装的方案执行`rime-install --update`
- **AND** 应显示更新进度和日志
- **AND** 完成后应重新部署所有方案

#### Scenario: 自定义Plum配方
- **WHEN** 用户选择"自定义配方"功能
- **THEN** 应允许用户输入Plum配方URL或脚本
- **AND** 应提供常用配方模板:
  - 安装朙月拼音
  - 安装地球拼音
  - 安装五笔86
  - 安装双拼
- **AND** 应保存用户的自定义配方供后续使用

### Requirement: 配置文件编辑
插件MUST提供安全、便捷的YAML配置文件编辑器。

#### Scenario: 配置文件列表
- **WHEN** 用户进入"配置编辑"页面
- **THEN** 应显示Rime目录中的所有YAML配置文件
- **AND** 应按类型分组:
  - 核心配置(default.custom.yaml, user.yaml等)
  - 方案配置(*.schema.yaml)
  - 字典配置(*.dict.yaml)
- **AND** 每个文件应显示:
  - 文件名
  - 最后修改时间
  - 文件大小
  - 是否为用户自定义(通过文件名判断)

#### Scenario: 编辑配置文件
- **WHEN** 用户选择一个配置文件
- **THEN** 应在编辑器中打开该文件
- **AND** 编辑器应提供:
  - YAML语法高亮
  - 行号显示
  - 自动缩进
  - 括号匹配
  - 错误提示(实时验证YAML语法)
- **AND** 应显示当前文件的schema信息(如有)

#### Scenario: 保存配置文件
- **WHEN** 用户编辑配置后点击"保存"
- **THEN** 应验证YAML语法
- **AND** 如果语法错误,应显示错误位置和原因
- **AND** 语法正确后应保存文件
- **AND** 应提示用户是否重新部署
- **AND** 应创建文件备份(保留最近5个版本)

#### Scenario: 配置文件对比
- **WHEN** 用户编辑default.custom.yaml等关键配置
- **THEN** 应提供"与原版对比"功能
- **AND** 应显示用户的修改和默认配置的差异
- **AND** 应使用并排或统一的diff视图
- **AND** 应支持回滚到默认配置

### Requirement: 部署和同步
插件MUST管理Rime的部署过程,确保配置变更生效。

#### Scenario: 手动部署
- **WHEN** 用户点击"重新部署"按钮
- **THEN** 应调用相应的部署命令:
  - Rime默认: `Deployer`命令
  - fcitx5-rime: 杀死fcitx5进程并重启
  - ibus-rime: 重启ibus
- **AND** 应显示部署进度
- **AND** 部署完成后应通知用户

#### Scenario: 自动部署
- **WHEN** 用户修改配置或安装方案后
- **THEN** 应根据用户设置决定是否自动部署
- **AND** 如果启用自动部署,应在操作完成后立即执行
- **AND** 如果禁用自动部署,应显示"需要部署才能生效"的提示

#### Scenario: 部署失败处理
- **WHEN** 部署过程失败
- **THEN** 应显示详细的错误信息
- **AND** 应提供常见的解决方案:
  - 检查YAML语法
  - 检查方案依赖
  - 查看详细日志
- **AND** 应提供"查看部署日志"功能

### Requirement: 字典管理
插件MUST提供用户词典的管理功能。

#### Scenario: 用户词典列表
- **WHEN** 用户进入"词典管理"页面
- **THEN** 应列出所有用户自定义词典(*.user.yaml)
- **AND** 每个词典应显示:
  - 词典名称
  - 词条数量
  - 文件大小
  - 最后更新时间
- **AND** 应支持搜索词条

#### Scenario: 编辑词条
- **WHEN** 用户选择一个用户词典
- **THEN** 应显示词典的所有词条
- **AND** 应支持:
  - 添加新词条(词组、编码、权重)
  - 编辑现有词条
  - 删除词条
  - 批量导入词条(从文本或CSV)
  - 导出词条为文本文件
- **AND** 修改后应自动保存并重新部署

#### Scenario: 词典同步
- **WHEN** 用户点击"同步词典"
- **THEN** 应提供同步选项:
  - 上传到云端(需要配置云存储)
  - 从云端下载
  - 导出为备份文件
- **AND** 应显示同步进度和结果

### Requirement: 方案预览和测试
插件MUST用户预览方案效果而无需完全切换。

#### Scenario: 方案详情预览
- **WHEN** 用户点击一个方案
- **THEN** 应显示方案的详细配置:
  - 方案名称和简介
  - 作者和版本
  - 支持的输入方式(拼音/双拼/五笔等)
  - 配置的快捷键
  - 样式和外观配置
  - 依赖的字典和方案
- **AND** 应显示方案的实际YAML配置内容(只读)

#### Scenario: 在线测试输入
- **WHEN** 用户选择"测试输入"功能
- **THEN** 应打开一个简单的输入测试框
- **AND** 应模拟该方案的输入行为
- **AND** 应显示候选词、编码提示等
- **AND** 此功能不需要实际安装方案

### Requirement: 配置备份和恢复
插件MUST提供配置的备份和恢复功能。

#### Scenario: 创建配置备份
- **WHEN** 用户点击"备份配置"
- **THEN** 应将整个Rime用户目录打包为压缩文件
- **AND** 应允许用户选择保存位置
- **AND** 应添加时间戳到备份文件名
- **AND** 应显示备份进度和文件大小

#### Scenario: 恢复配置备份
- **WHEN** 用户选择恢复备份文件
- **THEN** 应显示备份文件的基本信息:
  - 备份时间
  - 文件大小
  - 包含的方案和配置
- **AND** 应警告:恢复将覆盖当前所有配置
- **AND** 确认后应解压并覆盖
- **AND** 完成后应重新部署

#### Scenario: 自动备份
- **WHEN** 用户启用"自动备份"功能
- **THEN** 应在每次修改配置前自动创建备份
- **AND** 应保留最近N个备份(用户可配置,默认5个)
- **AND** 应自动清理过期备份
- **AND** 应显示可用的自动备份列表

### Requirement: 用户界面
插件MUST提供直观、易用的用户界面。

#### Scenario: 主界面布局
- **WHEN** 用户打开东风破插件
- **THEN** 主界面应包含:
  - 侧边栏: 功能导航(方案管理、配置编辑、词典管理、备份恢复)
  - 主内容区: 当前选中功能的界面
  - 顶部工具栏: 常用操作(重新部署、刷新、设置)
  - 底部状态栏: Rime状态、部署状态
- **AND** 应支持暗色模式
- **AND** 应支持响应式布局

#### Scenario: 方案卡片展示
- **WHEN** 在方案管理页面
- **THEN** 每个方案应以卡片形式展示
- **AND** 卡片应包含:
  - 方案图标(可自定义)
  - 方案名称
  - 简短描述
  - 标签
  - 操作按钮(安装/卸载/启用/禁用)
- **AND** 应支持网格或列表视图切换

#### Scenario: 搜索和筛选
- **WHEN** 用户在方案市场搜索
- **THEN** 应提供实时搜索结果
- **AND** 应支持按名称、作者、标签搜索
- **AND** 应提供高级筛选:
  - 按输入类型(拼音/双拼/形码)
  - 按语言(简体/繁体)
  - 按星级或下载量
- **AND** 应保存用户的筛选偏好

### Requirement: 错误处理和日志
插件MUST妥善处理各种错误情况。

#### Scenario: 网络错误处理
- **WHEN** 下载方案或字典时网络失败
- **THEN** 应显示友好的错误提示
- **AND** 应提供重试选项
- **AND** 应支持断点续传(如果支持)
- **AND** 应记录错误日志

#### Scenario: YAML语法错误
- **WHEN** 配置文件包含语法错误
- **THEN** 应在编辑器中高亮错误位置
- **AND** 应显示具体的错误信息和建议
- **AND** 应阻止保存错误的配置
- **AND** 应提供"打开备份"选项

#### Scenario: 部署失败
- **WHEN** Rime部署失败
- **THEN** 应显示详细的错误日志
- **AND** 应提供故障排除指南
- **AND** 应允许用户导出日志用于反馈

#### Scenario: 权限不足
- **WHEN** 操作因权限不足失败
- **THEN** 应显示权限请求
- **AND** 应说明需要访问的目录和原因
- **AND** 应提供手动修复指南

### Requirement: 权限管理
插件MUST申请和使用正确的系统权限。

#### Scenario: 权限申请
- **WHEN** 插件首次执行需要权限的操作
- **THEN** 应向主系统申请以下权限:
  - `fs:read`: 读取Rime配置目录
  - `fs:write`: 修改配置文件和安装方案
  - `process:spawn`: 执行部署命令和Plum脚本
  - `network:request`: 下载方案和字典
- **AND** 应在权限请求中说明操作的必要性

#### Scenario: 权限审计
- **WHEN** 用户查看插件权限使用情况
- **THEN** 应显示:
  - 已授予的所有权限
  - 每个权限的使用次数
  - 访问过的文件路径
  - 执行过的命令列表

### Requirement: 配置导入导出
插件MUST支持配置的导入导出,便于跨设备同步。

#### Scenario: 导出配置
- **WHEN** 用户选择"导出配置"
- **THEN** 应允许用户选择导出范围:
  - 仅方案列表
  - 仅用户配置
  - 用户词典
  - 全部配置
- **AND** 应导出为标准格式的文件
- **AND** 应允许添加备注信息

#### Scenario: 导入配置
- **WHEN** 用户选择"导入配置"
- **THEN** 应验证导入文件的格式和完整性
- **AND** 应显示配置预览和将要进行的操作
- **AND** 应提示用户确认导入
- **AND** 导入后应重新部署

### Requirement: 跨平台兼容性
插件MUST在支持的平台上提供一致的功能体验。

#### Scenario: 平台适配
- **WHEN** 插件在不同平台运行
- **THEN** 应自动适配平台的Rime配置目录
- **AND** 应使用正确的部署命令
- **AND** 应显示平台特定的帮助信息

#### Scenario: 输入法框架适配
- **WHEN** 检测到不同的输入法框架
- **THEN** 应提供针对该框架的专门功能:
  - fcitx5-rime: 支持fcitx5配置
  - ibus-rime: 支持ibus配置
  - Rime默认: 支持默认配置
- **AND** 应明确显示当前的框架类型

### Requirement: 快捷操作
插件MUST提供便捷的快捷操作功能。

#### Scenario: 快速启用方案
- **WHEN** 用户右键点击方案卡片
- **THEN** 应显示上下文菜单:
  - 设为默认方案
  - 启用/禁用
  - 查看详情
  - 编辑配置
  - 卸载
- **AND** 菜单项应根据当前状态启用/禁用

#### Scenario: 批量操作
- **WHEN** 用户选择多个方案
- **THEN** 应提供批量操作:
  - 批量启用
  - 批量禁用
  - 批量卸载
  - 批量更新
- **AND** 应显示确认对话框

### Requirement: 通知和提醒
插件MUST在适当的时候向用户发送通知。

#### Scenario: 更新提醒
- **WHEN** 检测到已安装的方案有更新
- **THEN** 应在界面中显示更新提示
- **AND** 应显示可更新的方案数量
- **AND** 用户可以配置检查更新的频率

#### Scenario: 部署完成通知
- **WHEN** 部署成功完成
- **THEN** 应显示桌面通知(如果用户启用)
- **AND** 通知应包含部署结果和方案数量
- **AND** 用户可以禁用此类通知

#### Scenario: 错误通知
- **WHEN** 发生严重错误(如配置损坏、部署失败)
- **THEN** 应立即显示错误通知
- **AND** 应提供快速访问错误日志的方式
- **AND** 应建议可能的解决方案
