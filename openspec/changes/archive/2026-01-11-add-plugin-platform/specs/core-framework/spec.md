 # 核心框架规格说明

## ADDED Requirements

### Requirement: 应用初始化和启动
系统MUST提供一个稳定的应用启动流程,确保所有核心服务正确初始化。

#### Scenario: 正常启动应用
- **WHEN** 用户启动应用
- **THEN** 应用主窗口应在3秒内显示
- **AND** 所有核心服务应初始化完成
- **AND** 插件管理器应开始扫描已安装的插件

#### Scenario: 首次启动引导
- **WHEN** 用户首次启动应用
- **THEN** 应显示欢迎界面
- **AND** 应创建必要的配置目录和文件
- **AND** 应提示用户完成基本设置

### Requirement: 插件生命周期管理
系统MUST提供完整的插件生命周期管理,包括加载、启用、禁用和卸载。

#### Scenario: 加载已安装插件
- **WHEN** 应用启动
- **THEN** 插件管理器应扫描`~/.rokun-tool/plugins/`目录
- **AND** 应读取每个插件的`manifest.json`文件
- **AND** 应验证插件的完整性和依赖关系
- **AND** 应跳过损坏或无效的插件,并记录错误日志

#### Scenario: 启用插件
- **WHEN** 用户启用一个已安装的插件
- **THEN** 系统应检查插件所需的权限
- **AND** 如果有未授权的权限,应显示权限请求对话框
- **AND** 用户授权后,应加载插件代码
- **AND** 应在插件列表中显示该插件为"已启用"状态

#### Scenario: 禁用插件
- **WHEN** 用户禁用一个运行中的插件
- **THEN** 系统应调用插件的`onDisable`生命周期方法
- **AND** 应释放插件占用的资源
- **AND** 应在插件列表中显示该插件为"已禁用"状态
- **AND** 禁用的插件不应再接收系统事件

#### Scenario: 卸载插件
- **WHEN** 用户卸载一个插件
- **THEN** 系统应先禁用该插件(如果正在运行)
- **AND** 应显示确认对话框,提示用户确认删除
- **AND** 应删除插件的数据目录
- **AND** 应从插件列表中移除该插件

### Requirement: 插件清单(Manifest)规范
系统MUST强制要求每个插件提供标准化的manifest.json文件。

#### Scenario: 有效的插件清单
- **WHEN** 系统读取插件的manifest.json
- **THEN** 该文件必须包含以下字段:
  - `name`: 插件唯一标识符(kebab-case)
  - `version`: 语义化版本号(如1.0.0)
  - `displayName`: 插件显示名称
  - `description`: 插件功能描述
  - `author`: 插件作者
  - `permissions`: 插件所需权限列表
  - `entry`: 插件入口文件路径
  - `minAppVersion`: 最低应用版本要求
- **AND** 系统应验证所有必填字段的存在
- **AND** 如果缺少必填字段,应拒绝加载该插件

#### Scenario: 插件图标和资源
- **WHEN** manifest.json包含`icon`字段
- **THEN** 系统应在插件列表中显示该图标
- **AND** 图标应为PNG或SVG格式
- **AND** 建议尺寸为256x256像素

### Requirement: 权限管理系统
系统MUST实现基于权限的访问控制,保护用户系统安全。

#### Scenario: 权限请求
- **WHEN** 插件首次请求需要权限的API
- **THEN** 系统应显示权限请求对话框
- **AND** 对话框应清晰说明:
  - 插件名称
  - 请求的权限类型
  - 该权限的作用范围
  - 安全风险提示(如有)
- **AND** 用户可以选择"允许"、"拒绝"或"始终允许"
- **AND** 用户的决定应被持久化保存

#### Scenario: 权限检查和执行
- **WHEN** 插件调用需要权限的API
- **THEN** 系统应检查该插件是否已获得相应权限
- **AND** 如果已授权,应执行请求的操作
- **AND** 如果未授权,应抛出`PermissionDenied`异常
- **AND** 所有权限操作应记录在审计日志中

#### Scenario: 权限撤销
- **WHEN** 用户在设置中撤销插件的某项权限
- **THEN** 系统应立即停止该插件访问相应API
- **AND** 如果插件正在使用该权限,应优雅地中断操作
- **AND** 应通知插件权限已被撤销

#### Scenario: 权限审计
- **WHEN** 用户查看插件的权限使用情况
- **THEN** 系统应显示:
  - 该插件已获得的所有权限
  - 每个权限的使用次数和最后使用时间
  - 该插件访问过的文件路径列表(如有文件访问权限)

### Requirement: 基础服务API
系统MUST提供标准化的API供插件调用,封装底层系统操作。

#### Scenario: 文件系统API
- **WHEN** 插件拥有`fs:read`权限
- **THEN** 可以调用`fs.readFile()`读取文件
- **AND** 文件路径必须在插件的数据目录或授权的目录范围内
- **AND** 尝试访问授权范围外的文件应抛出`AccessDenied`异常

#### Scenario: 文件写入API
- **WHEN** 插件拥有`fs:write`权限
- **THEN** 可以调用`fs.writeFile()`写入文件
- **AND** 系统应自动创建必要的父目录
- **AND** 写入操作应进行原子性保证
- **AND** 应记录所有写入操作的文件路径

#### Scenario: 进程管理API
- **WHEN** 插件拥有`process:spawn`权限
- **THEN** 可以调用`process.spawn()`启动外部进程
- **AND** 应允许指定进程参数和工作目录
- **AND** 应返回进程句柄,支持后续的进程管理
- **AND** 应监控进程的退出状态和资源使用

#### Scenario: 配置管理API
- **WHEN** 插件拥有`config:write`权限
- **THEN** 可以调用`config.set()`保存配置
- **AND** 配置应保存在`~/.rokun-tool/config/plugins.json`中
- **AND** 可以使用`config.get()`读取配置
- **AND** 配置变更应触发相应的事件通知

#### Scenario: IPC通信API
- **WHEN** 插件需要与主进程通信
- **THEN** 可以使用`ipc.invoke()`发送请求
- **AND** 应支持Promise风格的异步调用
- **AND** 可以使用`ipc.on()`监听主进程事件
- **AND** 应提供类型安全的TypeScript接口

### Requirement: 用户界面框架
系统MUST提供统一的UI组件库和设计系统。

#### Scenario: 主窗口布局
- **WHEN** 应用启动
- **THEN** 主窗口应包含:
  - 左侧边栏: 导航和插件列表
  - 主内容区: 当前选中的插件界面
  - 顶部工具栏: 全局操作和状态
  - 底部状态栏: 系统信息和通知
- **AND** 所有面板应支持用户自定义大小

#### Scenario: 插件UI容器
- **WHEN** 用户选择一个插件
- **THEN** 主内容区应加载该插件的UI组件
- **AND** 插件应运行在隔离的上下文中
- **AND** 插件UI应继承应用的全局样式
- **AND** 插件不应能访问主应用的DOM元素

#### Scenario: 深色模式
- **WHEN** 用户切换深色模式
- **THEN** 所有UI组件应立即响应主题变更
- **AND** 应保存用户的主题偏好
- **AND** 系统应自动检测操作系统的主题设置(可选)

#### Scenario: 响应式布局
- **WHEN** 用户调整窗口大小
- **THEN** 布局应流畅适应
- **AND** 侧边栏在窄窗口下应自动收起
- **AND** 插件UI应获得容器尺寸变更的通知

### Requirement: 日志和错误处理
系统MUST提供统一的日志记录和错误报告机制。

#### Scenario: 日志记录
- **WHEN** 插件或系统代码调用日志API
- **THEN** 日志应包含以下信息:
  - 时间戳(精确到毫秒)
  - 日志级别(DEBUG/INFO/WARN/ERROR)
  - 来源(插件名或系统组件)
  - 日志消息
  - 相关的元数据(如有)
- **AND** 日志应写入`~/.rokun-tool/logs/app.log`
- **AND** 日志文件应按日期自动轮转(每天一个文件)

#### Scenario: 错误处理
- **WHEN** 插件代码抛出未捕获的异常
- **THEN** 系统应捕获该异常
- **AND** 应记录详细的错误堆栈到日志
- **AND** 应向用户显示友好的错误提示
- **AND** 不应影响其他插件或主应用的运行

#### Scenario: 崩溃恢复
- **WHEN** 应用意外崩溃后重启
- **THEN** 系统应检测到崩溃日志
- **AND** 应显示"应用上次意外关闭"的提示
- **AND** 应提供"发送崩溃报告"的选项(可选)

### Requirement: 配置管理
系统MUST提供全局和应用级别的配置管理。

#### Scenario: 全局配置
- **WHEN** 应用首次启动
- **THEN** 应创建默认配置文件`~/.rokun-tool/config/app.json`
- **AND** 默认配置应包含:
  - 主题设置(light/dark)
  - 语言设置
  - 自动启动选项
  - 更新检查选项
  - 日志级别设置

#### Scenario: 配置持久化
- **WHEN** 用户修改任何配置项
- **THEN** 配置应立即保存到磁盘
- **AND** 应使用原子写入避免配置损坏
- **AND** 应创建配置备份(保留最近5个版本)

#### Scenario: 配置导入导出
- **WHEN** 用户选择"导出配置"
- **THEN** 系统应生成包含所有配置的JSON文件
- **AND** 应排除敏感信息(如权限令牌)
- **AND** 应允许用户选择导出范围(全部/仅应用/仅插件)

- **WHEN** 用户导入配置文件
- **THEN** 系统应验证配置文件的格式和版本
- **AND** 应显示将要变更的配置项预览
- **AND** 应要求用户确认后执行导入
- **AND** 导入失败时应提供回滚选项

### Requirement: 自动更新机制
系统MUST支持应用和插件的自动更新检查。

#### Scenario: 应用更新检查
- **WHEN** 应用启动或用户手动检查更新
- **THEN** 系统应向更新服务器查询最新版本
- **AND** 如果有新版本,应显示更新提示
- **AND** 应显示更新内容摘要和版本号
- **AND** 应允许用户选择"立即更新"、"稍后提醒"或"跳过该版本"

#### Scenario: 插件更新检查
- **WHEN** 用户在插件管理界面点击"检查更新"
- **THEN** 系统应检查所有已安装插件的更新
- **AND** 应显示有可用的插件更新列表
- **AND** 应支持单个或批量更新插件
- **AND** 更新前应自动备份当前版本

### Requirement: 数据隔离和存储
系统MUST确保每个插件的数据相互隔离。

#### Scenario: 插件数据目录
- **WHEN** 插件首次被启用
- **THEN** 系统应在`~/.rokun-tool/data/<plugin-name>/`创建专属目录
- **AND** 插件只能访问自己的数据目录
- **AND** 目录应包含标准的子目录结构:
  - `config/`: 插件配置文件
  - `cache/`: 缓存数据
  - `temp/`: 临时文件

#### Scenario: 数据清理
- **WHEN** 插件被卸载
- **THEN** 系统应询问用户是否删除插件数据
- **AND** 如果用户选择保留,数据目录应重命名为`<plugin-name>.archived`
- **AND** 如果用户选择删除,应彻底清除所有数据
- **AND** 清理操作应记录在日志中
