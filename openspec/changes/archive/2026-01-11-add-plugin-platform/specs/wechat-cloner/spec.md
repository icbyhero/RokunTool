# 微信分身创建器插件规格说明

## ADDED Requirements

### Requirement: 微信应用检测和版本管理
插件MUST能够自动检测系统中微信应用的安装位置、版本信息,并识别版本更新。

#### Scenario: 检测已安装的微信
- **WHEN** 插件被加载或用户点击"刷新"按钮
- **THEN** 插件应扫描常见的微信安装路径:
  - macOS: `/Applications/WeChat.app`
  - Windows: `%ProgramFiles%\Tencent\WeChat\` 或 `%ProgramFiles(x86)%\Tencent\WeChat\`
  - Linux: `/opt/wechat/` 或 `/opt/tencent/wechat/`
- **AND** 应显示检测到的微信版本号
- **AND** 如果未找到微信,应显示"未安装"状态并提供下载链接

#### Scenario: 检测微信主程序版本更新
- **WHEN** 微信主程序更新到新版本
- **THEN** 插件应在下次启动或刷新时检测到版本变化
- **AND** 应在所有旧版本分身的卡片上显示"可更新"标识
- **AND** 应显示主程序版本与分身版本的对比
- **AND** 底部状态栏应显示"有N个分身可更新"的提示

#### Scenario: 检测多个微信版本
- **WHEN** 系统中安装了多个版本的微信(如正式版和测试版)
- **THEN** 插件应列出所有找到的版本
- **AND** 应允许用户选择要创建分身的源版本
- **AND** 应为每个版本显示版本号和最后更新时间

### Requirement: 微信分身创建
插件MUST能够创建微信应用的独立副本,每个副本具有独立的Bundle Identifier、数据存储和版本追踪。

#### Scenario: 创建第一个分身
- **WHEN** 用户点击"创建分身"按钮
- **THEN** 插件应执行以下操作:
  1. 复制微信应用包到新位置
  2. 修改分身的Bundle Identifier(如`com.tencent.wechat2`)
  3. 对分身进行代码签名
  4. 创建独立的用户数据目录
  5. 记录分身版本信息到元数据文件
- **AND** 整个过程应显示进度条
- **AND** 创建成功后应显示成功提示
- **AND** 如果失败,应显示具体的错误信息和解决建议

#### Scenario: 创建多个分身
- **WHEN** 用户已有一个分身,再次点击"创建分身"
- **THEN** 新分身的Bundle Identifier应递增(如`com.tencent.wechat3`)
- **AND** 应为每个分身分配唯一的图标标识(如数字角标)
- **AND** 应限制最多创建5个分身(可配置)
- **AND** 每个分身应独立记录版本信息

#### Scenario: 分身命名
- **WHEN** 分身创建成功
- **THEN** 应提示用户为分身输入自定义名称
- **AND** 默认名称应为"微信分身N"(N为分身序号)
- **AND** 名称应显示在应用列表和启动器中

### Requirement: 分身版本更新
插件MUST提供便捷的方式来同步微信主程序的更新到分身,同时保留用户的聊天记录和配置。

#### Scenario: 更新单个分身
- **WHEN** 用户点击某个分身的"更新"按钮
- **THEN** 插件应执行以下操作:
  1. 显示更新确认对话框,说明:
     - 当前分身版本和目标版本
     - 更新过程不会影响聊天记录和配置
     - 更新期间分身将无法使用
     - 预计更新时间(基于历史数据估算)
  2. 等待用户确认后:
     - 停止正在运行的分身(如果需要)
     - 备份分身应用包到临时目录(防止更新失败)
     - 删除旧版本分身应用包
     - 复制最新版本微信应用包
     - 应用分身的Bundle Identifier和签名
     - 验证更新成功
     - 删除临时备份
  3. 显示更新完成提示
- **AND** 整个过程应显示详细进度
- **AND** 用户数据目录应保持不变,确保聊天记录完整保留

#### Scenario: 批量更新所有分身
- **WHEN** 用户点击"更新所有分身"按钮
- **THEN** 应显示批量更新确认对话框
- **AND** 应列出所有待更新的分身及其版本信息
- **AND** 应允许用户排除某些分身不更新
- **AND** 应依次执行每个分身的更新,显示总体进度
- **AND** 如果某个分身更新失败,应继续更新其他分身
- **AND** 完成后应显示更新结果报告(成功/失败列表)

#### Scenario: 更新失败回滚
- **WHEN** 分身更新过程中出现错误
- **THEN** 应立即停止更新操作
- **AND** 应使用临时备份还原旧版本分身
- **AND** 应显示详细的错误信息和建议
- **AND** 应记录错误日志供故障排查
- **AND** 如果无法还原,应提供"重新创建分身"的选项(保留数据)

#### Scenario: 自动更新检查
- **WHEN** 插件启动或用户手动点击"检查更新"
- **THEN** 应对比微信主程序版本和所有分身的版本
- **AND** 应标记所有可更新的分身
- **AND** 应在主界面显示更新通知横幅(如果有待更新的分身)
- **AND** 用户可以配置是否自动检查更新(默认启用)

### Requirement: 分身管理
插件MUST提供友好的界面来管理所有创建的微信分身。

#### Scenario: 列出所有分身
- **WHEN** 用户打开微信分身插件
- **THEN** 应显示所有已创建的分身列表
- **AND** 每个分身应显示:
  - 自定义名称
  - 应用图标
  - 当前版本号
  - 版本状态(最新/可更新/旧版本)
  - 最后使用时间
  - 当前状态(运行中/已停止)
- **AND** 应提供操作按钮:启动、设置、更新(如有新版本)、删除

#### Scenario: 启动分身
- **WHEN** 用户点击"启动"按钮
- **THEN** 插件应启动对应的微信分身应用
- **AND** 应记录启动时间到日志
- **AND** 如果分身已经在运行,应切换到该应用窗口
- **AND** 如果分身有可用的版本更新,应显示更新提示(可关闭)

#### Scenario: 停止分身
- **WHEN** 用户点击"停止"按钮
- **THEN** 插件应优雅地关闭对应的微信分身
- **AND** 应提示用户保存未保存的工作(如果支持)
- **AND** 应等待最多5秒,如果应用未响应则强制终止

#### Scenario: 删除分身
- **WHEN** 用户点击"删除"按钮
- **THEN** 应显示确认对话框
- **AND** 对话框应警告:删除操作不可恢复,但数据目录可选择保留
- **AND** 用户确认后,应:
  1. 先停止分身(如果正在运行)
  2. 删除应用包
  3. 询问是否删除用户数据
- **AND** 删除成功后应从列表中移除

### Requirement: 数据隔离和保留
插件MUST确保每个微信分身使用独立的用户数据,互不干扰,并且在更新过程中完整保留。

#### Scenario: 数据目录独立设置(m macOS)
- **WHEN** 微信分身创建或更新
- **THEN** 应设置独立的数据目录:
  - 原版微信: `~/Library/Containers/com.tencent.xin/Data/Documents`
  - 分身1: `~/Library/Containers/com.tencent.wechat2/Data/Documents`
  - 分身2: `~/Library/Containers/com.tencent.wechat3/Data/Documents`
- **AND** 应通过环境变量或配置文件实现路径重定向
- **AND** 每个分身的聊天记录、配置、缓存应完全独立

#### Scenario: 数据目录独立设置(Windows)
- **WHEN** 微信分身创建或更新
- **THEN** 应设置独立的数据目录:
  - 原版微信: `%Documents%\Tencent Files\WeChat Files`
  - 分身1: `%Documents%\Tencent Files\WeChat Files2`
  - 分身2: `%Documents%\Tencent Files\WeChat Files3`
- **AND** 应通过命令行参数或注册表实现路径重定向

#### Scenario: 更新时保留数据
- **WHEN** 执行分身版本更新
- **THEN** 数据目录应保持完全不变
- **AND** 只替换应用包,不触及用户数据目录
- **AND** 更新前后应验证数据目录的完整性
- **AND** 应在更新前创建数据目录的快照备份(可选)

#### Scenario: 数据备份和恢复
- **WHEN** 用户选择"备份分身数据"
- **THEN** 应将分身的数据目录打包为ZIP文件
- **AND** 应允许用户选择保存位置
- **AND** 应显示备份进度和完成提示

- **WHEN** 用户选择"恢复分身数据"
- **THEN** 应解压备份文件到对应分身的数据目录
- **AND** 应提示用户恢复操作将覆盖当前数据
- **AND** 恢复后应建议重启分身

### Requirement: 代码签名
插件MUST为创建和更新后的微信分身进行代码签名,确保系统能够正常启动。

#### Scenario: 自动签名(m macOS)
- **WHEN** 分身创建或更新完成后
- **THEN** 应使用自签名证书对分身进行签名
- **AND** 应执行`codesign --force --deep --sign -`命令
- **AND** 签名成功后应显示"已签名"状态
- **AND** 如果签名失败,应显示错误信息和手动签名指南

#### Scenario: 签名验证
- **WHEN** 用户在分身设置中点击"验证签名"
- **THEN** 应执行`codesign -v`验证签名有效性
- **AND** 应显示验证结果(有效/无效)
- **AND** 如果签名无效,应提供重新签名的选项

### Requirement: 元数据管理
插件MUST维护每个分身的元数据信息,用于版本追踪和管理。

#### Scenario: 元数据记录
- **WHEN** 分身创建或更新
- **THEN** 应在元数据文件中记录:
  - 分身名称
  - Bundle Identifier
  - 基于的主程序版本
  - 创建时间
  - 最后更新时间
  - 应用包路径
  - 数据目录路径
  - 签名状态
- **AND** 元数据文件应保存在`~/.rokun-tool/data/wechat-cloner/metadata.json`

#### Scenario: 版本对比
- **WHEN** 检查分身版本更新
- **THEN** 应对比元数据中的版本和主程序版本
- **AND** 应使用语义化版本比较(如1.0.2 < 1.0.10)
- **AND** 应标记所有版本低于主程序的分身

### Requirement: 配置管理
插件MUST允许用户自定义分身创建和更新行为参数。

#### Scenario: 全局设置
- **WHEN** 用户打开插件设置
- **THEN** 应提供以下配置选项:
  - 最大分身数量(默认5,范围1-10)
  - 分身默认安装位置
  - 是否自动签名(默认启用)
  - 是否自动检查更新(默认启用)
  - 更新策略:自动更新/手动确认/仅通知(默认:手动确认)
  - 是否在更新前创建数据备份(默认启用)
  - 日志级别(默认INFO)

#### Scenario: 分身特定设置
- **WHEN** 用户点击某个分身的"设置"
- **THEN** 应允许修改:
  - 分身显示名称
  - 分身图标(支持自定义图片)
  - 启动参数(高级选项)
  - 是否开机自启(该分身)
  - 是否参与自动更新(默认启用)

### Requirement: 错误处理和恢复
插件MUST妥善处理各种错误情况,并提供清晰的错误信息和解决方案。

#### Scenario: 微信未安装
- **WHEN** 插件未检测到微信应用
- **THEN** 应显示友好的提示:"未检测到微信应用"
- **AND** 应提供微信官网下载链接
- **AND** 应提供"重新检测"按钮

#### Scenario: 磁盘空间不足
- **WHEN** 创建或更新分身时磁盘空间不足
- **THEN** 应显示错误提示:"磁盘空间不足"
- **AND** 应显示所需空间和当前可用空间
- **AND** 应建议用户清理磁盘空间后重试

#### Scenario: 权限不足
- **WHEN** 操作因权限不足而失败
- **THEN** 应显示错误提示:"权限不足"
- **AND** macOS应提示用户需要管理员权限
- **AND** 应提供使用sudo重新运行的指南

#### Scenario: 分身损坏
- **WHEN** 检测到分身应用包损坏
- **THEN** 应在列表中标记该分身为"损坏"状态
- **AND** 应提供"修复"选项(重新复制和签名)
- **AND** 如果无法修复,应建议删除并重新创建(保留数据)

#### Scenario: 更新失败恢复
- **WHEN** 分身更新过程失败
- **THEN** 应自动使用备份还原到更新前状态
- **AND** 应显示失败原因和错误代码
- **AND** 应提供"重试"和"取消"选项
- **AND** 如果还原失败,应提供紧急恢复指南

### Requirement: 性能监控
插件MUST监控微信分身的资源使用情况。

#### Scenario: 资源使用统计
- **WHEN** 用户在分身列表中查看详情
- **THEN** 应显示以下信息:
  - 分身进程的CPU使用率
  - 分身进程的内存占用
  - 分身的数据目录大小
  - 分身的运行时长
- **AND** 数据应每5秒刷新一次

#### Scenario: 性能警告
- **WHEN** 某个分身的内存占用超过2GB
- **THEN** 应在界面中显示警告标识
- **AND** 应提示用户可能需要清理缓存或重启分身
- **AND** 不应强制关闭分身,由用户决定

### Requirement: 安全性
插件MUST确保操作的安全性,不泄露用户敏感信息。

#### Scenario: 敏感信息保护
- **WHEN** 显示分身列表或日志
- **THEN** 不应显示用户的微信账号信息
- **AND** 不应包含聊天记录的内容
- **AND** 错误日志应过滤路径中的用户名(如显示`~/Library/...`而非完整路径)

#### Scenario: 权限申请
- **WHEN** 插件首次执行需要权限的操作
- **THEN** 应向主系统申请以下权限:
  - `fs:read`: 读取微信应用包
  - `fs:write`: 创建分身和修改文件
  - `process:spawn`: 执行复制、签名、启动命令
- **AND** 应在权限请求中说明操作的必要性

### Requirement: 用户界面
插件MUST提供直观易用的用户界面。

#### Scenario: 主界面布局
- **WHEN** 用户打开微信分身插件
- **THEN** 主界面应包含:
  - 顶部: 工具栏(创建分身、更新所有、刷新、设置按钮)
  - 中部: 分身列表(卡片式布局,显示版本状态)
  - 底部: 状态栏(微信版本、分身数量、待更新数量)
- **AND** 界面应适配暗色模式
- **AND** 支持响应式布局

#### Scenario: 版本更新标识
- **WHEN** 分身列表中显示有可更新的分身
- **THEN** 应在分身卡片上显示明显的"可更新"徽章
- **AND** 应显示当前版本和最新版本的对比
- **AND** "更新"按钮应高亮显示,吸引用户注意

#### Scenario: 创建向导
- **WHEN** 用户点击"创建分身"
- **THEN** 应显示分步向导:
  1. 选择源版本(如果检测到多个微信)
  2. 确认分身名称和位置
  3. 创建进度显示
  4. 完成提示和下一步操作建议
- **AND** 每个步骤应清晰直观
- **AND** 应支持"上一步"和"取消"操作

#### Scenario: 更新向导
- **WHEN** 用户点击"更新分身"
- **THEN** 应显示更新向导:
  1. 显示更新内容和版本变化
  2. 提示数据将保留的说明
  3. 更新进度显示(包括备份、替换、签名等步骤)
  4. 完成提示和验证结果
- **AND** 应提供"取消"按钮(在更新开始前)
- **AND** 更新开始后应显示预计剩余时间

#### Scenario: 右键菜单
- **WHEN** 用户右键点击分身卡片
- **THEN** 应显示上下文菜单:
  - 启动/停止
  - 更新(如有新版本)
  - 打开数据目录
  - 备份数据
  - 设置
  - 删除
- **AND** 菜单项应根据当前状态启用/禁用(如运行中时禁用"删除")

### Requirement: 跨平台兼容性
插件MUST在支持的平台上提供一致的功能体验。

#### Scenario: 平台特定提示
- **WHEN** 插件在不同平台运行
- **THEN** 应显示平台特定的帮助信息:
  - macOS: 说明代码签名和Gatekeeper相关设置
  - Windows: 说明防火墙和杀毒软件可能的影响
  - Linux: 说明权限和依赖库要求
- **AND** 应提供平台专门的故障排除指南

#### Scenario: 功能降级
- **WHEN** 某些功能在当前平台不可用
- **THEN** 应隐藏或禁用相应的功能按钮
- **AND** 应显示说明该功能仅支持特定平台
- **AND** 核心功能(创建、更新、启动、删除分身)应在所有平台可用

### Requirement: 更新历史和日志
插件MUST记录分身的创建和更新历史,便于用户追溯。

#### Scenario: 更新历史记录
- **WHEN** 用户在分身设置中点击"查看历史"
- **THEN** 应显示该分身的完整历史记录:
  - 创建时间和版本
  - 每次更新的时间和版本
  - 每次操作的结果(成功/失败)
  - 相关的错误日志(如有)
- **AND** 应允许用户导出历史记录为文本文件

#### Scenario: 操作日志
- **WHEN** 插件执行任何关键操作
- **THEN** 应记录详细日志到`~/.rokun-tool/logs/wechat-cloner.log`
- **AND** 日志应包含时间戳、操作类型、参数、结果
- **AND** 应提供日志查看和导出功能
- **AND** 日志文件应按大小自动轮转(最大10MB)
