# 测试框架建立 - 实现任务清单

## 1. 测试框架配置 (优先级: 🔴 高)

**预计工期**: 1天
**依赖**: 无

### 1.1 安装测试依赖
- [ ] 1.1.1 安装 Vitest 核心依赖
  - [ ] 安装 `vitest`
  - [ ] 安装 `@vitest/ui` (可选,测试可视化界面)
  - [ ] 安装 `@vitest/coverage-c8` (代码覆盖率)

- [ ] 1.1.2 安装组件测试依赖
  - [ ] 安装 `@testing-library/react`
  - [ ] 安装 `@testing-library/jest-dom`
  - [ ] 安装 `@testing-library/user-event`
  - [ ] 安装 `happy-dom` 或 `jsdom` (DOM环境)

- [ ] 1.1.3 安装 E2E 测试依赖
  - [ ] 安装 `@playwright/test`
  - [ ] 安装 Playwright Electron 适配器

### 1.2 创建配置文件
- [ ] 1.2.1 创建 Vitest 配置
  - [ ] 创建 `vitest.config.ts`
  - [ ] 配置测试环境 (happy-dom/jsdom/node)
  - [ ] 配置测试覆盖率目标
  - [ ] 配置测试文件匹配模式
  - [ ] 配置测试超时时间

- [ ] 1.2.2 创建测试环境设置
  - [ ] 创建 `test/setup.ts`
  - [ ] 配置全局测试变量
  - [ ] 配置测试 Mock 工具
  - [ ] 配置测试清理逻辑

- [ ] 1.2.3 创建 Playwright 配置
  - [ ] 创建 `playwright.config.ts`
  - [ ] 配置 Electron 测试环境
  - [ ] 配置测试超时和重试
  - [ ] 配置测试报告输出

### 1.3 配置 npm 脚本
- [ ] 1.3.1 添加测试脚本到 package.json
  - [ ] `test` - 运行单元测试
  - [ ] `test:ui` - 运行测试UI
  - [ ] `test:coverage` - 运行测试并生成覆盖率报告
  - [ ] `test:e2e` - 运行E2E测试
  - [ ] `test:all` - 运行所有测试

**里程碑**: ✅ 测试框架配置完成,可以运行基础测试

---

## 2. 创建测试工具和 Mock (优先级: 🔴 高)

**预计工期**: 1天
**依赖**: 测试框架配置完成

### 2.1 创建 Mock 数据和工具
- [ ] 2.1.1 创建 Electron Mock
  - [ ] Mock Electron app 对象
  - [ ] Mock BrowserWindow 对象
  - [ ] Mock ipcMain 和 ipcRenderer
  - [ ] Mock dialog 和 shell

- [ ] 2.1.2 创建文件系统 Mock
  - [ ] Mock fs/promises 模块
  - [ ] 创建虚拟文件系统工具
  - [ ] 提供临时目录创建/清理工具

- [ ] 2.1.3 创建插件 Mock 数据
  - [ ] 创建标准插件 package.json fixture
  - [ ] 创建标准插件 index.js fixture
  - [ ] 创建插件元数据 fixture

- [ ] 2.1.4 创建测试工具函数
  - [ ] 创建 mock 插件工厂函数
  - [ ] 创建 mock 插件实例工厂
  - [ ] 创建测试断言辅助函数

### 2.2 创建测试模板
- [ ] 2.2.1 创建单元测试模板
  - [ ] 创建标准测试文件模板
  - [ ] 创建 describe/test 命名规范示例
  - [ ] 创建 beforeEach/afterEach 模板

- [ ] 2.2.2 创建组件测试模板
  - [ ] 创建组件渲染测试模板
  - [ ] 创建用户交互测试模板
  - [ ] 创建快照测试模板

- [ ] 2.2.3 创建 E2E 测试模板
  - [ ] 创建页面对象模型模板
  - [ ] 创建测试场景模板
  - [ ] 创建测试断言模板

**里程碑**: ✅ 测试工具和 Mock 完成,可以开始编写测试

---

## 3. 单元测试 - 核心模块 (优先级: 🔴 高)

**预计工期**: 3-4天
**依赖**: 测试框架配置完成

### 3.1 插件加载器测试
- [ ] 3.1.1 创建测试文件
  - [ ] 创建 `src/main/plugins/loader.test.ts`
  - [ ] 配置测试套件结构

- [ ] 3.1.2 测试插件目录扫描
  - [ ] 测试扫描插件目录成功
  - [ ] 测试空目录处理
  - [ ] 测试目录不存在处理

- [ ] 3.1.3 测试插件元数据解析
  - [ ] 测试有效 package.json 解析
  - [ ] 测试缺少必需字段
  - [ ] 测试无效格式
  - [ ] 测试无效 ID 格式
  - [ ] 测试无效版本格式

- [ ] 3.1.4 测试插件加载成功
  - [ ] 测试单个插件加载
  - [ ] 测试插件 onLoad 钩子调用
  - [ ] 测试插件状态更新
  - [ ] 测试插件注册到 registry

- [ ] 3.1.5 测试插件加载失败处理
  - [ ] 测试模块导入失败
  - [ ] 测试 onLoad 抛出错误
  - [ ] 测试错误状态标记

- [ ] 3.1.6 测试插件启用/禁用
  - [ ] 测试插件启用流程
  - [ ] 测试 onEnable 钩子调用
  - [ ] 测试插件禁用流程
  - [ ] 测试 onDisable 钩子调用

- [ ] 3.1.7 测试插件卸载
  - [ ] 测试插件卸载流程
  - [ ] 测试 onUnload 钩子调用
  - [ ] 测试插件从 registry 移除

### 3.2 权限系统测试
- [ ] 3.2.1 创建测试文件
  - [ ] 创建 `src/main/permissions/permission-service.test.ts`
  - [ ] 配置测试套件结构

- [ ] 3.2.2 测试权限加载
  - [ ] 测试权限文件加载成功
  - [ ] 测试权限文件不存在处理
  - [ ] 测试权限文件格式错误处理

- [ ] 3.2.3 测试权限检查
  - [ ] 测试 hasPermission 单个权限检查
  - [ ] 测试 hasPermissions 多个权限检查
  - [ ] 测试未授予权限返回 false

- [ ] 3.2.4 测试权限授予
  - [ ] 测试授予权限成功
  - [ ] 测试重复授予权限(幂等性)
  - [ ] 测试权限持久化
  - [ ] 测试权限文件写入

- [ ] 3.2.5 测试权限撤销
  - [ ] 测试撤销部分权限
  - [ ] 测试撤销所有权限
  - [ ] 测试撤销后权限检查失败
  - [ ] 测试权限文件更新

- [ ] 3.2.6 测试权限查询
  - [ ] 测试获取插件所有权限
  - [ ] 测试获取所有已授权插件列表
  - [ ] 测试空权限情况

### 3.3 IPC 通信测试
- [ ] 3.3.1 创建测试文件
  - [ ] 创建 `src/main/ipc/handlers.test.ts`
  - [ ] 配置测试套件结构

- [ ] 3.3.2 测试 IPC 消息注册
  - [ ] 测试处理器注册成功
  - [ ] 测试重复注册处理
  - [ ] 测试处理器覆盖

- [ ] 3.3.3 测试 IPC 消息路由
  - [ ] 测试消息路由到正确处理器
  - [ ] 测试未知消息处理
  - [ ] 测试消息参数传递

- [ ] 3.3.4 测试消息验证
  - [ ] 测试有效消息通过验证
  - [ ] 测试无效消息格式拒绝
  - [ ] 测试缺少必需参数拒绝
  - [ ] 测试参数类型验证

- [ ] 3.3.5 测试错误处理
  - [ ] 测试处理器抛出错误的捕获
  - [ ] 测试错误消息返回
  - [ ] 测试错误不崩溃应用

- [ ] 3.3.6 测试超时处理
  - [ ] 测试操作超时处理
  - [ ] 测试超时返回错误
  - [ ] 测试超时清理资源

### 3.4 服务层测试
- [ ] 3.4.1 文件系统服务测试
  - [ ] 创建 `src/main/services/fs.test.ts`
  - [ ] 测试 readFile 操作
  - [ ] 测试 writeFile 操作
  - [ ] 测试 readDir 操作
  - [ ] 测试 stat 操作
  - [ ] 测试权限检查
  - [ ] 测试错误处理(文件不存在等)

- [ ] 3.4.2 进程服务测试
  - [ ] 创建 `src/main/services/process.test.ts`
  - [ ] 测试 spawn 进程
  - [ ] 测试 exec 命令
  - [ ] 测试 kill 进程
  - [ ] 测试命令白名单验证
  - [ ] 测试命令拒绝(未授权)
  - [ ] 测试进程清理

- [ ] 3.4.3 配置服务测试
  - [ ] 创建 `src/main/services/config.test.ts`
  - [ ] 测试配置读取
  - [ ] 测试配置写入
  - [ ] 测试配置删除
  - [ ] 测试配置不存在默认值
  - [ ] 测试配置类型转换

- [ ] 3.4.4 日志服务测试
  - [ ] 创建 `src/main/services/logger.test.ts`
  - [ ] 测试日志级别过滤
  - [ ] 测试日志格式化
  - [ ] 测试日志输出
  - [ ] 测试日志持久化(可选)

### 3.5 Rime 插件测试
- [ ] 3.5.1 创建测试文件
  - [ ] 创建 `plugins/rime-config/index.test.ts`
  - [ ] 配置测试套件结构

- [ ] 3.5.2 测试 Rime 目录检测
  - [ ] 测试检测标准 Rime 目录
  - [ ] 测试检测 fcitx5 目录
  - [ ] 测试检测 ibus 目录
  - [ ] 测试未安装 Rime 处理

- [ ] 3.5.3 测试配方列表获取
  - [ ] 测试返回配方列表
  - [ ] 测试配方数量正确(5个)
  - [ ] 测试配方结构正确
  - [ ] 测试未安装时状态为 false

- [ ] 3.5.4 测试配方安装(使用 mock)
  - [ ] Mock context.api.process.exec
  - [ ] 测试调用 rime-install 命令
  - [ ] 测试成功后更新状态
  - [ ] 测试安装失败处理

- [ ] 3.5.5 测试配方更新
  - [ ] 测试调用 rime-install 命令
  - [ ] 测试更新后状态更新
  - [ ] 测试更新失败处理

- [ ] 3.5.6 测试配方卸载
  - [ ] 测试识别配方文件
  - [ ] 测试删除配方文件
  - [ ] 测试更新状态
  - [ ] 测试卸载失败处理

- [ ] 3.5.7 测试 Rime 部署
  - [ ] Mock context.api.process.exec
  - [ ] 测试调用 rime_deployer 命令
  - [ ] 测试部署成功处理
  - [ ] 测试部署失败处理

**里程碑**: ✅ 核心模块单元测试完成,覆盖率 > 60%

---

## 4. 集成测试 (优先级: 🟡 中)

**预计工期**: 2-3天
**依赖**: 单元测试完成

### 4.1 E2E 测试框架配置
- [ ] 4.1.1 配置 Playwright Electron
  - [ ] 安装 Playwright Electron 适配器
  - [ ] 配置 Electron 应用路径
  - [ ] 配置测试环境变量

- [ ] 4.1.2 创建 E2E 测试基础代码
  - [ ] 创建测试基础设置
  - [ ] 创建页面对象模型
  - [ ] 创建测试辅助函数

### 4.2 编写 E2E 测试用例
- [ ] 4.2.1 应用启动流程测试
  - [ ] 测试应用成功启动
  - [ ] 测试主窗口显示
  - [ ] 测试插件列表加载
  - [ ] 测试无错误日志

- [ ] 4.2.2 插件加载流程测试
  - [ ] 测试扫描插件目录
  - [ ] 测试加载插件元数据
  - [ ] 测试调用 onLoad 钩子
  - [ ] 测试插件状态为 loaded

- [ ] 4.2.3 插件卸载流程测试
  - [ ] 测试调用插件卸载
  - [ ] 测试调用 onUnload 钩子
  - [ ] 测试插件从列表移除

- [ ] 4.2.4 权限申请流程测试
  - [ ] 测试插件声明权限
  - [ ] 测试自动授予权限
  - [ ] 测试权限持久化
  - [ ] 测试后续操作使用权限

- [ ] 4.2.5 插件方法调用流程测试
  - [ ] 测试前端调用插件方法
  - [ ] 测试 IPC 路由到主进程
  - [ ] 测试插件方法执行
  - [ ] 测试结果返回到前端
  - [ ] 测试错误处理

**里程碑**: ✅ E2E 测试完成,主要用户流程已验证

---

## 5. 测试优化和文档 (优先级: 🟢 低)

**预计工期**: 1天
**依赖**: 所有测试完成

### 5.1 测试性能优化
- [ ] 5.1.1 配置测试并行化
  - [ ] 配置 Vitest pool 选项
  - [ ] 配置线程数
  - [ ] 测试并行效果

- [ ] 5.1.2 优化测试运行时间
  - [ ] 识别慢速测试
  - [ ] 优化 Mock 策略
  - [ ] 优化测试隔离

### 5.2 测试文档
- [ ] 5.2.1 创建测试指南
  - [ ] 编写测试运行说明
  - [ ] 编写测试编写指南
  - [ ] 编写 Mock 使用说明

- [ ] 5.2.2 更新项目文档
  - [ ] 更新 README 添加测试部分
  - [ ] 更新贡献指南
  - [ ] 添加测试最佳实践

**里程碑**: ✅ 测试框架完全建立,文档完善

---

## 任务说明

- **预计总工期**: 8-10天 (约1.5-2周)
- **核心团队**: 1名开发者
- **里程碑**:
  - Day 2: 测试框架配置完成
  - Day 3: 测试工具和 Mock 完成
  - Day 7: 单元测试完成
  - Day 10: E2E 测试完成

## 依赖关系

- **第1阶段**: 测试框架配置 (无依赖,可立即开始)
- **第2阶段**: 测试工具和 Mock (依赖第1阶段)
- **第3阶段**: 单元测试 (依赖第2阶段)
- **第4阶段**: E2E 测试 (依赖第3阶段)
- **第5阶段**: 测试优化和文档 (依赖所有测试完成)

## 验收标准

### 测试框架配置
- ✅ Vitest 可以运行测试
- ✅ Playwright 可以运行 E2E 测试
- ✅ 代码覆盖率可以生成报告

### 单元测试
- ✅ 所有测试通过
- ✅ 覆盖率 > 60% (核心模块)
- ✅ 测试运行时间 < 10秒

### E2E 测试
- ✅ 主要用户流程测试通过
- ✅ 测试运行时间 < 30秒
- ✅ 测试稳定,可重复运行

### 优先级说明

- 🔴 **高优先级**: 核心功能,必须完成
- 🟡 **中优先级**: 重要功能,建议完成
- 🟢 **低优先级**: 优化和文档,可后续完成
