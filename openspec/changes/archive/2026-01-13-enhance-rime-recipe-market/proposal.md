# enhance-rime-recipe-market Proposal

## Summary

完善 Rime 配置管理插件的配方市场功能,添加官方配方列表,实现配方分类显示、互斥逻辑(词库配方只能同时安装一种)、以及完整的配方安装/卸载/更新体验。

## Why

当前 Rime 配置插件的配方市场功能存在以下问题:

1. **配方列表不完整** - 只有少量 rime-ice 相关的配方,缺少官方配方仓库中的其他流行配方(如朙月拼音、双拼、五笔、仓颉等)
2. **缺少分类组织** - 没有配方分类展示,用户难以查找所需配方
3. **配置安全性不足** - 缺少配置备份功能,修改配置前无法自动备份,一旦出错难以恢复
4. **用户体验不完整** - 配方安装、卸载、更新的流程需要改进,缺少清晰的反馈和提示

这些限制导致用户:
- 难以发现和安装适合的输入方案
- 担心配置修改后无法恢复
- 不清楚配方的分类和用途
- 缺少配置安全保护机制

参考官方配方列表: https://rime.im/recipes/

## What Changes

本提案将在以下方面进行改进:

### 1. 配方数据扩展 (recipe-categories spec)
- 添加 21 种官方配方定义
- 实现 8 个配方分类:基础配置、词库、拼音、双拼、方言、笔画、符号、工具
- 为每个配方添加分类、文件列表等元数据

### 2. 配方市场功能 (recipe-market spec)
- 实现配方列表展示和分类筛选
- 添加配方搜索功能
- 实现文件冲突检测和自动解决
- 改进配方安装/卸载/更新流程

### 3. 安装跟踪系统 (installation-tracking spec)
- 实现配方安装标记文件系统
- 支持混合检测策略(标记文件 + 特征文件)
- 准确识别配方安装状态

### 4. 配置备份系统 (config-backup spec)
- 实现自动备份功能(所有配置修改前)
- 实现备份管理(列表、恢复、删除)
- 支持长期备份标记
- 自动清理策略(最多10份,最多3个月)

所有规格增量文档位于 `specs/` 目录下。

## Background

当前 Rime 配置插件的配方市场功能有限:
1. 只有少量 rime-ice 相关的配方
2. 缺少官方配方列表中的其他流行配方(如朙月拼音、双拼、五笔、仓颉等)
3. 没有配方分类展示,用户难以查找
4. 缺少配方互斥逻辑,可能导致词库冲突
5. 配方安装、卸载、更新的用户体验不完整

参考官方配方列表: https://rime.im/recipes/

## Goals

### 主要目标

1. **扩展配方列表** - 添加官方配方仓库中的常用配方
2. **实现配方分类** - 按类别组织配方(基础配置、词库、输入方案、符号等)
3. **实现互斥逻辑** - 词库配方只能同时安装一种,避免冲突
4. **改进用户体验** - 优化配方安装、卸载、更新流程

### 次要目标

1. 支持配方搜索和筛选
2. 显示配方详细信息
3. 提供配方依赖检查
4. 优化错误处理和用户提示
5. **实现配置自动备份** - 每次配置更新前自动备份
   - 保留最近10份备份
   - 自动清理超过3个月的备份
   - 支持长期备份标记

## Non-Goals

- 实现在线配方商店(从远程获取配方列表)
- 配方评价和评论系统
- 自定义配方创建功能
- 配方分享功能

## Approach

### 1. 配方数据结构

扩展配方定义,添加以下字段:
- `category`: 配方分类(基础配置、词库、输入方案等)
- `exclusive`: 互斥组标识(词库配方标记为 "vocabulary")
- `dependencies`: 依赖的其他配方
- `conflicts`: 冲突的配方

### 2. 配方分类

实现以下分类:
- **基础配置**: prelude(基础配置)
- **词库配方**: rime-ice(雾凇拼音)、essay(八股文)、octagram(八股文语言模型)
- **拼音输入**: luna-pinyin(朙月拼音)、terra-pinyin(地球拼音)
- **双拼方案**: double-pinyin(双拼)、combo-pinyin(宫保拼音)
- **方言输入**: jyutping(粤拼)、wugniu(吴语上海话)
- **笔画输入**: stroke(五笔画)、wubi(五笔)、cangjie(仓颉)、quick(速成)等
- **符号输入**: emoji(绘文字)、ipa(国际音标)
- **工具类**: opencc(简繁转换)

### 3. 互斥逻辑

实现配方互斥检查:
- 安装词库配方前,检查是否已安装其他词库配方
- 如果存在冲突,提示用户并自动卸载旧配方
- 更新配方安装状态,确保 UI 正确显示

### 4. 前端 UI 改进

- 按分类展示配方,使用标签页或折叠面板
- 显示配方的安装状态、描述、类别
- 提供搜索框,支持按名称和描述搜索
- 优化安装/卸载按钮,显示加载状态

### 5. 插件后端改进

- 实现配方互斥检查逻辑
- 改进配方检测方法,支持更多配方
- 优化错误处理和日志记录

### 6. 配置备份系统

- 每次配置更新前自动创建备份
- 备份文件使用时间戳命名 (格式: `backup-YYYY-MM-DD-HH-mm-ss/`)
- 保留策略:
  - 最多保留10份备份 (超过后删除最旧的)
  - 最多保留3个月 (超过期限的自动删除)
  - 特殊标记为"长期保存"的备份不受限制
- 支持手动创建备份和恢复备份
- 提供备份列表UI,显示备份时间、大小、类型

## Success Criteria

1. ✅ 配方市场包含至少 20 种官方配方
2. ✅ 配方按分类清晰组织
3. ✅ 词库配方互斥逻辑正常工作
4. ✅ 配方安装、卸载、更新功能完整
5. ✅ 用户界面友好,操作流畅
6. ✅ TypeScript 类型检查通过
7. ✅ 构建成功,无错误和警告
8. ✅ 配置备份系统正常工作
9. ✅ 备份清理策略正确执行
10. ✅ 备份恢复功能可用

## Risks & Mitigations

### Risk 1: 配方安装失败
- **影响**: 用户无法使用某些配方
- **缓解**: 提供详细的错误信息,指导用户手动安装

### Risk 2: 配方冲突检测不准确
- **影响**: 可能导致配置文件损坏
- **缓解**: 充分测试互斥逻辑,提供备份功能

### Risk 3: 配方列表过大影响性能
- **影响**: 页面加载慢
- **缓解**: 使用虚拟滚动,延迟加载

## Alternatives Considered

### Alternative 1: 从远程 API 获取配方列表
- **优点**: 配方列表总是最新的
- **缺点**: 需要网络连接,增加复杂度
- **未采用原因**: 当前阶段先实现内置配方列表

### Alternative 2: 允许同时安装多个词库配方
- **优点**: 更灵活
- **缺点**: 可能导致冲突和配置复杂
- **未采用原因**: 用户明确要求只能同时存在一种词库

## Dependencies

### 现有功能
- Rime 插件系统 ✅
- 进度反馈系统 ✅
- 权限系统 ✅

### 外部依赖
- Rime Plum (rime-install 命令)
- Rime 部署工具 (rime_deployer)

## Timeline

- 阶段1: 扩展配方列表和分类 (已完成部分代码)
- 阶段2: 实现互斥逻辑
- 阶段3: 更新前端 UI
- 阶段4: 测试和修复

预计总工作量: 4-6 小时

## Out of Scope

- 配方版本管理和更新检查
- 配方依赖自动解决
- 自定义配方创建
- 配方分享和社区功能
