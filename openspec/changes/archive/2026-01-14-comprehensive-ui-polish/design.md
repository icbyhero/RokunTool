## 设计文档: UI主题优化

## 背景

应用使用Tailwind CSS和暗色模式实现,通过在document元素上切换`dark`类来工作。UI组件使用Radix UI原语和自定义样式构建。当前问题包括:

1. **硬编码的文本颜色** - 许多组件使用`text-gray-900`等类似类名,但没有`dark:`变体
2. **不一致的徽章使用** - 权限状态徽章没有遵循统一的视觉语言
3. **缺少暗色模式变体** - 某些UI组件缺少正确的暗色模式样式

应用通过`useUIStore`支持主题切换,将`dark`类应用到`document.documentElement`。

### 约束条件

- 必须保持向后兼容 - 不破坏组件API
- 必须遵循现有的Tailwind CSS模式
- 不应引入新的依赖(继续使用class-variance-authority、Radix UI)
- 需要确保可访问性(WCAG AA对比度标准)

### 利益相关者

- 最终用户: 更好的可读性和用户体验,特别是暗色模式
- 开发者: 更清晰的主题支持模式,更容易维护
- 未来贡献者: 既定指南防止引入类似问题

## 目标 / 非目标

**目标:**
- 修复所有暗色模式文本可见性问题
- 建立一致的徽章变体使用模式
- 为现有和未来组件创建可复用的主题模式
- 记录组件开发的最佳实践

**非目标:**
- 重新设计整体UI/UX(保持当前设计,只修复问题)
- 更改组件API或行为
- 引入新的UI组件库
- 性能优化(除非当前方法有问题)

## 技术决策

### 决策1: 文本颜色模式

**内容:** 为文本颜色建立标准的Tailwind类模式

**模式:**
- **标题**: `text-gray-900 dark:text-white`
- **正文文本**: `text-gray-700 dark:text-gray-300`
- **次要文本**: `text-gray-600 dark:text-gray-400`
- **弱化文本**: `text-gray-500 dark:text-gray-500`
- **禁用文本**: `text-gray-400 dark:text-gray-600`

**理由:** 这些模式在明暗两种模式下都提供了清晰的层次,同时保持了适当的对比度(4.5:1或更好)。

**考虑的替代方案:**
- 使用CSS自定义属性 - 拒绝,因为已经广泛使用Tailwind类
- 自动颜色反转 - 拒绝,因为它不考虑语义层次
- 保持当前方法 - 拒绝,因为它导致暗色模式下的文本不可见

### 决策2: 徽章变体标准化

**内容:** 为徽章变体定义清晰的语义含义

**标准:**
- `default`: 主要操作,主状态
- `secondary`: 中性,信息性,或待处理状态
- `destructive`: 错误状态,拒绝的权限,破坏性操作
- `outline`: 中性边框,微妙的指示器
- `success`: 成功状态,已授权权限,已完成操作
- `warning`: 警告状态,敏感权限
- `info`: 信息性状态

**权限状态映射:**
- 已授权 → `success`变体(绿色,正面)
- 已拒绝 → `destructive`变体(红色,负面)
- 待处理 → `secondary`变体(灰色,中性)

**理由:** 创建一致的视觉语言,其中颜色含义在整个应用中是可预测的。

**考虑的替代方案:**
- 创建自定义权限专用徽章 - 拒绝,因为现有变体已足够
- 只使用outline徽章 - 拒绝,因为颜色提供重要的语义含义
- 保持当前不一致的使用 - 拒绝,因为它造成视觉混乱

### 决策3: 暗色模式实现策略

**内容:** 对所有依赖于主题的样式使用Tailwind的`dark:`变体前缀

**方法:**
- 为所有颜色工具类添加`dark:`变体
- 确保每个在主题间变化的颜色类都有两个变体
- 使用语义颜色名称(gray)而不是字面颜色(black/white)

**理由:** 与现有实现一致,主题切换逻辑中不需要代码更改。

**考虑的替代方案:**
- 带有主题变量的CSS自定义属性 - 拒绝,因为它需要大量重构
- 主题的独立组件文件 - 拒绝,因为它造成重复
- 使用主题提供者组件 - 拒绝,因为当前基于store的方法效果很好

### 决策4: 组件审计优先级

**内容:** 按用户影响修复组件

**优先级顺序:**
1. **严重** - 暗色模式下文本不可见的组件(PluginDetail权限)
2. **高** - 频繁使用且对比度差的组件(Badge、Button)
3. **中** - 不常使用的页面(Settings、About)
4. **低** - 轻微的视觉不一致

**理由:** 确保首先修复最重要的问题,提供立即可见的用户价值。

**考虑的替代方案:**
- 按字母顺序 - 拒绝,因为它不优先考虑用户影响
- 一次性修复 - 拒绝,因为它使测试和验证更困难
- 按文件大小顺序 - 拒绝,因为大小与重要性不相关

## 风险 / 权衡

### 风险1: 对比度合规性

**风险:** 某些颜色组合可能无法满足WCAG AA标准,即使修复后也是如此

**缓解措施:**
- 在测试期间使用在线对比度检查工具
- 记录任何边界情况
- 不确定时选择更高的对比度
- 如需要,考虑调整调色板

### 风险2: 修复的不一致应用

**风险:** 某些组件可能被遗漏或接收不完整的修复

**缓解措施:**
- 在开始修复前进行全面审计
- 基于检查清单的任务跟踪
- 在两种主题中彻底测试
- 所有更改的同行评审

### 风险3: 明色模式视觉回归

**风险:** 暗色模式修复可能意外影响明色模式外观

**缓解措施:**
- 同等测试两种主题
- 确保保留明色模式变体
- 视觉回归测试(截图)(如果可能)
- 增量更改和验证

### 风险4: 性能影响

**风险:** 添加更多`dark:`变体会增加CSS包大小

**缓解措施:**
- Tailwind在基本配置中已包含暗色模式支持
- JIT编译器消除未使用的样式
- 现代浏览器高效处理变体类
- 考虑到可访问性好处,权衡是可接受的

## 迁移计划

### 阶段1: 准备
1. 对所有组件进行全面审计
2. 记录发现的所有问题
3. 创建或更新组件检查清单

### 阶段2: 组件修复
1. 按优先级顺序修复UI组件
2. 在更改后测试每个组件的两种主题
3. 验证现有功能没有回归

### 阶段3: 页面修复
1. 按优先级顺序修复页面组件
2. 标准化所有页面的徽章使用
3. 在两种主题中测试用户流程

### 阶段4: 文档
1. 创建主题使用指南
2. 记录常见模式
3. 添加组件开发检查清单

### 阶段5: 验证
1. 两种主题的全面测试
2. 可访问性审计
3. 跨浏览器测试
4. 修复任何剩余问题

### 回滚计划

如果发现严重问题:
1. 按组件增量回滚更改
2. 保留文档以供将来参考
3. 为发现的任何问题创建issue
4. 通过调整重新应用修复

不需要数据迁移或API更改,因此回滚是直接的git revert。

## 开放问题

1. **我们应该将颜色对比度作为代码审查的一部分吗?**
   - 可以防止未来问题
   - 可能会减慢开发
   - 可以通过linting工具自动化

2. **我们应该添加自动化视觉回归测试吗?**
   - 可以捕获主题相关的回归
   - 需要设置和维护
   - 对于当前团队规模可能过度

3. **我们应该将颜色板记录为Tailwind配置参考吗?**
   - 将帮助开发者选择正确的颜色
   - 需要维护文档
   - 如果不执行可能会过时

4. **我们应该考虑添加"系统主题"选项吗?**
   - 将自动匹配操作系统主题偏好
   - 用户请求的功能
   - 超出当前变更范围,但相关
