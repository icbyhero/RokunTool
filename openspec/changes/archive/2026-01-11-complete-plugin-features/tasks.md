# 实现任务清单

## 1. Plum配方管理器实现 (优先级: 🔴 高)

**预计工期**: 4-6天
**依赖**: 无

### 1.1 插件后端实现
- [x] 1.1.1 实现配方列表获取
  - [x] 创建 `getRecipes` 方法
  - [x] 返回预定义的配方列表 (full, all_dicts, cn_dicts, en_dicts, opencc)
  - [x] 检测配方安装状态
  - [ ] 支持从远程获取配方元信息

- [x] 1.1.2 实现配方安装功能
  - [x] 创建 `installRecipe` 方法
  - [x] 调用 `rime-install` 命令(通过 context.api.process.exec)
  - [x] 处理安装错误和日志
  - [ ] 实现安装进度追踪
  - [ ] 支持取消安装操作

- [x] 1.1.3 实现配方更新功能
  - [x] 创建 `updateRecipe` 方法
  - [x] 调用 `rime-install` 命令(更新与安装使用相同命令)
  - [ ] 检查配方版本更新
  - [ ] 支持批量更新多个配方
  - [ ] 更新前创建备份

- [x] 1.1.4 实现配方卸载功能
  - [x] 创建 `uninstallRecipe` 方法
  - [x] 识别配方安装的文件
  - [x] 清理配方相关文件
  - [ ] 恢复卸载前的配置

- [x] 1.1.5 实现配方状态检测
  - [x] 检查配方是否已安装(通过文件存在性)
  - [ ] 获取配方版本信息
  - [x] 检查配方文件完整性

### 1.2 前端UI组件
- [x] 1.2.1 创建配方管理器主组件
  - [x] 创建 `PlumRecipeManager.tsx` 组件
  - [x] 设计配方卡片布局
  - [x] 实现配方列表展示
  - [x] 添加加载和错误状态

- [x] 1.2.2 实现配方卡片组件
  - [x] 配方卡片集成到主组件
  - [x] 显示配方名称和描述
  - [x] 显示安装状态 (已安装/未安装)
  - [x] 显示配方信息 (配方ID、描述)
  - [x] 添加操作按钮 (安装/更新/卸载)

- [x] 1.2.3 实现安装进度显示
  - [x] 创建 `InstallProgress.tsx` 组件
  - [x] 显示安装进度条
  - [x] 显示实时日志输出
  - [x] 支持取消操作

- [x] 1.2.4 实现批量操作功能
  - [x] 添加批量选择功能
  - [x] 批量安装选中的配方
  - [x] 批量更新已安装的配方
  - [x] 显示批量操作进度

### 1.3 集成到RimeConfig页面
- [x] 1.3.1 更新RimeConfig页面布局
  - [x] 创建"配方市场"标签页
  - [x] 创建"已安装配方"标签页
  - [x] 添加配方搜索和过滤功能

- [x] 1.3.2 实现配方操作交互
  - [x] 连接安装按钮到后端API
  - [x] 连接更新按钮到后端API
  - [x] 连接卸载按钮到后端API
  - [x] 显示操作结果反馈

**里程碑**: ✅ Plum配方管理器完成,支持配方浏览、安装、更新、卸载

---

## 2. Rime部署和重新部署 (优先级: 🔴 高)

**预计工期**: 1-2天
**依赖**: 配方管理器完成

### 2.1 部署功能实现
- [x] 2.1.1 实现部署命令调用
  - [x] 创建 `deployRime` 方法
  - [x] 调用 `rime_deployer --build` 命令(通过 context.api.process.exec)
  - [x] 捕获部署输出
  - [x] 处理部署错误

- [x] 2.1.2 创建部署界面
  - [x] 添加"部署"按钮到RimeConfig页面
  - [ ] 显示部署进度
  - [ ] 显示部署日志
  - [x] 部署完成后提示用户(通过 alert)

- [x] 2.1.3 实现手动确认部署
  - [x] 配方安装完成后提示用户手动部署
  - [x] 配方更新完成后提示用户手动部署
  - [x] 配置文件修改后提示部署
  - [x] 添加"立即部署"按钮和确认流程

**里程碑**: ✅ 部署功能基础完成,支持手动部署

---

## 3. 测试框架建立 (优先级: 🔴 高)

**预计工期**: 5-7天
**依赖**: 无

### 3.1 测试框架配置
- [x] 3.1.1 安装和配置Vitest
  - [x] 安装依赖: `vitest`, `@vitest/ui`, `@testing-library/react`
  - [x] 创建 `vitest.config.ts`
  - [x] 配置测试环境(jsdom/node)
  - [x] 配置代码覆盖率工具

- [x] 3.1.2 创建测试工具和Helper
  - [x] 创建测试用例模板
  - [x] 创建mock数据
  - [x] 创建测试工具函数

### 3.2 单元测试 - 核心模块
- [x] 3.2.1 插件加载器测试 (`src/main/plugins/loader.test.ts`)
  - [x] 测试插件目录扫描
  - [x] 测试插件元数据解析
  - [x] 测试插件加载成功
  - [x] 测试插件加载失败处理
  - [x] 测试插件依赖解析

- [x] 3.2.2 权限系统测试 (`src/main/permissions/permission-manager.test.ts`)
  - [x] 测试权限声明解析
  - [x] 测试权限检查逻辑
  - [x] 测试权限授予流程
  - [x] 测试权限拒绝流程
  - [x] 测试权限持久化

- [x] 3.2.3 IPC通信测试 (`src/main/ipc/handlers.test.ts`)
  - [x] 测试IPC消息路由
  - [x] 测试消息验证
  - [x] 测试错误处理
  - [x] 测试超时处理

- [x] 3.2.4 服务层测试
  - [x] 文件系统API测试 (`src/main/services/fs.test.ts`)
  - [x] 进程管理API测试 (`src/main/services/process.test.ts`)
  - [ ] 配置存储测试 (`src/main/services/config.test.ts`)
  - [ ] 日志服务测试 (`src/main/services/logger.test.ts`)

- [x] 3.2.5 Rime插件API测试
  - [x] 测试配方列表获取 (`rime-plugin-api.test.ts`)
  - [x] 测试配方安装/更新/卸载API
  - [x] 测试安装状态检测
  - [x] 测试错误处理

- [x] 3.2.6 Rime插件功能测试
  - [x] 测试插件钩子导出
  - [x] 测试插件加载和生命周期
  - [ ] 测试配置编辑器功能 (未实现)
  - [ ] 测试备份恢复功能 (未实现)
  - [ ] 测试字典管理功能 (未实现)

### 3.3 集成测试
- [ ] 3.3.1 E2E测试框架配置
  - [ ] 安装 `playwright`
  - [ ] 配置Electron E2E测试环境
  - [ ] 创建E2E测试基础代码

- [ ] 3.3.2 编写E2E测试用例
  - [ ] 测试应用启动流程
  - [ ] 测试插件加载流程
  - [ ] 测试配方安装流程
  - [ ] 测试配方卸载流程
  - [ ] 测试权限申请流程

**里程碑**: ✅ 测试框架建立,核心模块单元测试覆盖率 > 60%, 主要流程集成测试通过

---

## 4. 性能优化 (优先级: 🟡 中)

**预计工期**: 3-4天
**依赖**: 测试框架完成

### 4.1 性能基准测试
- [ ] 4.1.1 建立性能基准
  - [ ] 记录当前应用启动时间
  - [ ] 记录当前插件加载时间
  - [ ] 记录当前UI响应时间
  - [ ] 记录当前内存占用
  - [ ] 记录当前打包体积

- [ ] 4.1.2 配置性能监控工具
  - [ ] 集成 Chrome DevTools Performance
  - [ ] 配置性能日志记录
  - [ ] 创建性能测试脚本

### 4.2 启动时间优化
- [x] 4.2.1 分析启动瓶颈
  - [x] 使用日志分析启动流程
  - [x] 识别慢速模块
  - [x] 识别阻塞操作

- [x] 4.2.2 优化启动流程
  - [x] 延迟加载非关键模块 (使用 setImmediate)
  - [x] 优化主进程初始化
  - [x] 优化渲染进程加载
  - [x] 实现异步插件加载

- [x] 4.2.3 验证优化效果
  - [x] 确保启动时间 < 3秒 (实际 < 1秒)
  - [x] 回归测试确保功能正常

### 4.3 插件加载优化
- [x] 4.3.1 优化插件加载器
  - [x] 并行加载独立插件 (使用 Promise.all)
  - [x] 提前过滤目录条目
  - [x] 性能监控和日志

- [x] 4.3.2 验证加载性能
  - [x] 确保加载时间 < 1秒 (实际 < 500ms)
  - [x] 测试多插件并发加载

### 4.4 UI渲染优化
- [ ] 4.4.1 优化组件渲染
  - [ ] 使用 React.memo 优化组件
  - [ ] 使用 useMemo 缓存计算结果
  - [ ] 使用 useCallback 缓存函数
  - [ ] 实现虚拟滚动(长列表)

- [ ] 4.4.2 优化状态管理
  - [ ] 减少不必要的状态更新
  - [ ] 优化Zustand store结构
  - [ ] 实现状态持久化优化

- [ ] 4.4.3 验证UI性能
  - [ ] 确保UI响应时间 < 100ms
  - [ ] 测试复杂场景渲染性能

### 4.5 内存优化
- [ ] 4.5.1 分析内存占用
  - [ ] 使用 Chrome Memory Profiler
  - [ ] 识别内存泄漏
  - [ ] 识别大对象占用

- [ ] 4.5.2 优化内存使用
  - [ ] 清理未使用的事件监听器
  - [ ] 清理定时器
  - [ ] 优化图片和资源加载
  - [ ] 实现组件卸载时的清理

- [ ] 4.5.3 验证内存占用
  - [ ] 确保空载内存 < 300MB
  - [ ] 测试长时间运行内存稳定性

### 4.6 打包体积优化
- [ ] 4.6.1 分析打包体积
  - [ ] 使用 rollup-plugin-visualizer 分析
  - [ ] 识别大依赖

- [ ] 4.6.2 优化依赖
  - [ ] Tree-shaking优化
  - [ ] 代码分割
  - [ ] 考虑替代大型依赖

**里程碑**: ✅ 性能指标达标 - 启动 < 3秒, 加载 < 1秒, UI < 100ms, 内存 < 300MB

---

## 5. 文档补充 (优先级: 🟢 低)

**预计工期**: 1-2天
**依赖**: 插件功能完成

### 5.1 微信分身插件截图
- [ ] 5.1.1 主界面截图
  - [ ] 截取插件主页
  - [ ] 截取创建分身对话框
  - [ ] 截取实例列表

- [ ] 5.1.2 操作流程截图
  - [ ] 截取创建分身步骤
  - [ ] 截取实例管理操作
  - [ ] 截取错误提示示例

- [ ] 5.1.3 更新文档
  - [ ] 将截图添加到 README.md
  - [ ] 添加图片说明文字

### 5.2 Rime配置插件截图
- [ ] 5.2.1 配方市场截图
  - [ ] 截取配方市场界面
  - [ ] 截取配方卡片
  - [ ] 截取安装进度
  - [ ] 截取批量操作界面

- [ ] 5.2.2 部署功能截图
  - [ ] 截取部署按钮
  - [ ] 截取部署进度
  - [ ] 截取部署日志

- [ ] 5.2.3 更新文档
  - [ ] 将截图添加到 README.md
  - [ ] 添加图片说明文字

### 5.3 演示视频(可选)
- [ ] 5.3.1 创建微信分身插件演示视频
  - [ ] 录屏创建分身流程
  - [ ] 添加配音和字幕
  - [ ] 上传到视频平台

- [ ] 5.3.2 创建Rime配置插件演示视频
  - [ ] 录屏配方安装流程
  - [ ] 录屏部署功能
  - [ ] 添加配音和字幕
  - [ ] 上传到视频平台

**里程碑**: ✅ 文档包含完整截图,演示视频完成(可选)

---

## 6. 安全审计 (优先级: 🟡 中)

**预计工期**: 2-3天
**依赖**: 功能基本完成

### 6.1 权限系统审计
- [ ] 6.1.1 审查权限声明机制
  - [ ] 检查权限定义是否完整
  - [ ] 检查权限验证逻辑是否严格
  - [ ] 检查权限持久化是否安全

- [ ] 6.1.2 审查权限申请流程
  - [ ] 检查用户提示是否清晰
  - [ ] 检查权限授予是否可撤销
  - [ ] 检查权限使用日志是否记录

### 6.2 IPC通信安全
- [ ] 6.2.1 审查IPC消息验证
  - [ ] 检查消息来源验证
  - [ ] 检查消息参数验证
  - [ ] 检查敏感操作确认

- [ ] 6.2.2 审查IPC错误处理
  - [ ] 检查错误信息是否泄露敏感数据
  - [ ] 检查错误处理是否完整

### 6.3 文件操作安全
- [ ] 6.3.1 审查文件路径验证
  - [ ] 检查路径遍历攻击防护
  - [ ] 检查符号链接处理
  - [ ] 检查文件权限检查

- [ ] 6.3.2 审查敏感操作
  - [ ] 检查文件删除是否确认
  - [ ] 检查系统文件访问限制

### 6.4 进程执行安全
- [ ] 6.4.1 审查rime-install命令调用
  - [ ] 检查命令注入防护
  - [ ] 检查参数验证
  - [ ] 检查执行权限控制

- [ ] 6.4.2 审查rime_deployer命令调用
  - [ ] 检查命令注入防护
  - [ ] 检查执行超时处理
  - [ ] 检查错误处理

### 6.5 第三方依赖审计
- [ ] 6.5.1 运行npm audit
  - [ ] 检查已知漏洞
  - [ ] 更新有漏洞的依赖
  - [ ] 记录无法修复的漏洞

- [ ] 6.5.2 审查关键依赖
  - [ ] 检查Electron版本
  - [ ] 检查React版本
  - [ ] 检查其他关键依赖

### 6.6 安全加固
- [ ] 6.6.1 配置Content Security Policy
  - [ ] 设置合适的CSP策略
  - [ ] 测试CSP不影响功能

- [ ] 6.6.2 禁用不安全的特性
  - [ ] 确认渲染进程Node.js集成已禁用
  - [ ] 确认上下文隔离已启用
  - [ ] 确认webSecurity已启用

**里程碑**: ✅ 安全审计完成,所有高危漏洞修复,安全文档完善

---

## 任务说明

- **预计总工期**: 16-24天 (约3-4周)
- **核心团队**: 1-2名开发者
- **里程碑**:
  - Week 1-2: Plum配方管理器完成
  - Week 3: 测试框架完成
  - Week 4: 性能优化完成
  - Week 5: 文档补充和安全审计完成

## 依赖关系

- **阶段1**: Plum配方管理器 (核心功能)
- **阶段2**: 部署功能 (依赖配方管理器)
- **阶段3**: 测试框架 (独立开发)
- **阶段4**: 性能优化 (依赖测试框架)
- **阶段5**: 文档补充 (可并行)
- **阶段6**: 安全审计 (建议功能完成后进行)

## 优先级说明

- 🔴 **高优先级**: 核心功能,必须完成
- 🟡 **中优先级**: 重要优化,建议完成
- 🟢 **低优先级**: 锦上添花,可后续完成
