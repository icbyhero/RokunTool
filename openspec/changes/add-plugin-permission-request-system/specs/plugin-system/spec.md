# 插件系统权限管理规范

## ADDED Requirements

### Requirement: 运行时权限请求

插件系统必须支持在运行时动态请求敏感权限,而不是在安装时自动授予所有权限。

#### Scenario: 插件请求文件写入权限

**Given** 微信分身插件已安装但未授予文件写入权限
**When** 用户尝试创建微信分身实例
**And** 插件调用需要 `fs:write` 权限的 API
**Then** 系统应该暂停操作并显示权限请求对话框
**And** 对话框应该包含:
- 插件名称和图标
- 请求的权限类型 (文件写入)
- 权限使用说明 (复制微信应用到 /Applications)
- 目标路径 (/Applications/WeChat2.app)
- 安全提示信息
- "允许"、"拒绝"、"取消" 按钮
**And** 用户选择"允许"后,操作应该继续执行
**And** 权限状态应该保存为"已授予"

#### Scenario: 权限被拒绝时返回错误

**Given** 插件请求 `fs:write` 权限
**And** 用户选择"拒绝"
**Then** 操作应该中止
**And** 插件应该收到 `PermissionDeniedError`
**And** 错误消息应该明确说明:
- 缺少哪个权限
- 为什么需要该权限
- 如何在设置中授予权限

#### Scenario: 已授予的权限直接执行

**Given** 插件之前已被授予 `fs:write` 权限
**When** 插件再次调用需要该权限的 API
**Then** 操作应该立即执行,不显示权限请求对话框
**And** 不需要额外的 IPC 通信

#### Scenario: 已拒绝的权限不重复请求

**Given** 用户之前拒绝了插件的 `fs:write` 权限请求
**When** 插件再次调用需要该权限的 API
**Then** 操作应该立即失败
**And** 返回 `PermissionDeniedError`
**And** 不显示权限请求对话框

---

### Requirement: 权限状态持久化

系统必须持久化保存用户的权限选择,并在应用重启后恢复。

#### Scenario: 权限状态在应用重启后保持

**Given** 用户授予了微信分身插件的 `fs:write` 权限
**When** 用户重启应用
**And** 再次尝试创建微信分身
**Then** 操作应该成功执行,不需要重新请求权限

#### Scenario: 权限撤销后立即生效

**Given** 微信分身插件已被授予 `fs:write` 权限
**When** 用户在设置页面撤销该权限
**Then** 所有正在执行需要该权限的操作应该失败
**And** 新的操作需要重新请求权限
**And** 权限状态应该持久化到磁盘

#### Scenario: 权限历史记录

**Given** 用户授予或拒绝了插件权限
**When** 用户在设置页面查看权限历史
**Then** 系统应该显示:
- 权限授予/拒绝的时间戳
- 权限类型
- 操作结果 (授予/拒绝)

---

### Requirement: 权限分类

系统必须区分基础权限和敏感权限,并使用不同的授权策略。

#### Scenario: 基础权限自动授予

**Given** 插件在 `package.json` 中声明了基础权限
**And** 权限类型为 `fs:read`、`config:read` 或 `notification:show`
**When** 插件安装或启用
**Then** 权限应该自动授予,不需要用户确认

#### Scenario: 敏感权限需要用户确认

**Given** 插件在 `package.json` 中声明了敏感权限
**And** 权限类型为 `fs:write`、`process:spawn`、`process:exec` 等
**When** 插件首次使用该权限
**Then** 系统必须显示权限请求对话框
**And** 必须等待用户明确同意

#### Scenario: 权限分类列表

**基础权限** (自动授予):
- `fs:read` - 读取文件
- `config:read` - 读取配置
- `notification:show` - 显示通知

**敏感权限** (需要用户确认):
- `fs:write` - 写入文件
- `process:spawn` - 启动进程
- `process:exec` - 执行命令
- `shell:execute` - 执行 Shell 命令
- `process:kill` - 终止进程
- `network:http` - HTTP 请求

---

### Requirement: 权限管理界面

系统必须在插件设置页面提供权限管理功能。

#### Scenario: 查看插件权限状态

**Given** 用户打开了插件详情页面
**Then** 应该显示"权限管理"区域
**And** 列出该插件的所有权限
**And** 每个权限应该显示:
- 权限名称和图标
- 当前状态 (已授予/已拒绝/未授予)
- 权限说明
- 操作按钮 (授予/撤销)

#### Scenario: 撤销已授予的权限

**Given** 插件已被授予 `fs:write` 权限
**When** 用户在权限管理页面点击"撤销"按钮
**Then** 权限状态应该更改为"已拒绝"
**And** 更改应该立即生效
**And** 状态应该持久化到磁盘

#### Scenario: 重新授予已拒绝的权限

**Given** 插件的 `fs:write` 权限被拒绝
**When** 用户在权限管理页面点击"授予"按钮
**Then** 权限状态应该更改为"已授予"
**And** 插件可以立即使用该权限

#### Scenario: 查看权限历史

**Given** 用户在插件详情页面
**Then** 应该显示"权限历史"区域
**And** 按时间倒序列出所有权限变更记录
**And** 每条记录应该包含:
- 时间戳
- 权限类型
- 操作 (授予/撤销)
- 操作来源 (用户请求/系统自动)

---

### Requirement: 权限错误处理

系统必须提供清晰的错误信息和恢复指导。

#### Scenario: PermissionDeniedError 包含完整上下文

**Given** 插件因权限不足而操作失败
**When** 系统抛出 `PermissionDeniedError`
**Then** 错误对象应该包含:
- `pluginId`: 插件 ID
- `permission`: 缺少的权限类型
- `operation`: 尝试执行的操作
- `message`: 用户友好的错误说明
**And** 错误消息应该引导用户:
- 说明为什么需要该权限
- 提供在设置中授予权限的指导

#### Scenario: 插件可以降级处理权限错误

**Given** 插件尝试执行可选操作
**And** 操作需要 `fs:write` 权限
**When** 权限被拒绝
**Then** 插件应该能够捕获 `PermissionDeniedError`
**And** 提供降级功能或替代方案
**And** 向用户说明功能受限的原因

#### Scenario: 必需权限错误时显示帮助链接

**Given** 插件执行必需操作
**And** 操作因权限不足失败
**When** 显示错误消息
**Then** 应该提供"授予权限"按钮
**And** 点击后应该跳转到权限管理页面
**And** 自动定位到相关权限设置

---

### Requirement: 权限请求队列

系统必须处理并发的权限请求,避免多个对话框同时显示。

#### Scenario: 多个权限请求依次显示

**Given** 插件同时请求多个权限
**When** 第一个权限请求对话框显示
**Then** 其他请求应该在队列中等待
**And** 只有当前请求处理完成后才显示下一个

#### Scenario: 用户取消权限请求

**Given** 插件请求权限
**When** 用户点击"取消"按钮
**Then** 操作应该中止
**And** 权限状态保持为"未授予"
**And** 不记录拒绝状态

#### Scenario: 相同权限的重复请求合并

**Given** 插件 A 请求 `fs:write` 权限
**And** 对话框正在显示
**When** 插件 A 或其他插件再次请求相同权限
**Then** 不应该创建新的对话框
**And** 两个操作应该等待同一个用户决定

---

## MODIFIED Requirements

### Requirement: 插件元数据验证

**之前的描述**: 插件在 `package.json` 中声明所需权限,系统在加载时验证。

**修改后的描述**:
插件在 `package.json` 中声明所需权限。系统在加载时验证权限声明的有效性,但不自动授予敏感权限。基础权限在插件启用时自动授予,敏感权限在首次使用时请求用户授权。

**理由**: 渐进式权限授权策略,提高用户对权限的感知和控制。

#### Scenario: 插件加载时验证权限声明

**Given** 插件的 `package.json` 包含 `permissions` 字段
**When** 插件加载
**Then** 系统应该验证所有权限都是有效的
**And** 无效的权限声明应该导致加载失败
**And** 记录警告日志

---

## 安全考虑

### Requirement: 权限最小化原则

插件应该只请求必需的权限,并在权限请求中说明具体用途。

#### Scenario: 权限请求包含操作上下文

**Given** 微信分身插件请求 `fs:write` 权限
**When** 显示权限请求对话框
**Then** 应该明确说明:
- 为什么需要此权限 (创建微信分身)
- 将访问哪些路径 (/Applications 目录)
- 操作的风险级别 (中等)

#### Scenario: 权限请求频率限制

**Given** 用户拒绝了插件的权限请求
**When** 插件在短时间内重复请求相同权限
**Then** 系统应该拒绝重复请求
**And** 记录警告日志
**And** 提示插件开发者正确处理权限错误

---

## 性能要求

### Requirement: 权限检查性能

权限检查必须高效,不影响插件正常执行。

#### Scenario: 已授予权限的检查性能

**Given** 插件已被授予所需权限
**When** 插件调用需要权限的 API
**Then** 权限检查应该 < 1ms
**And** 不涉及 IPC 通信 (内存检查)

#### Scenario: 权限状态缓存

**Given** 权限状态已加载到内存
**When** 多次检查同一权限
**Then** 应该使用缓存的状态
**And** 不重复读取存储文件

---

## 兼容性要求

### Requirement: 向后兼容

新的权限系统必须与现有插件兼容。

#### Scenario: 旧插件继续工作

**Given** 旧版插件没有实现权限请求逻辑
**When** 插件调用需要权限的 API
**And** 权限未授予
**Then** 系统应该自动触发权限请求
**And** 插件不需要修改代码

#### Scenario: 权限状态迁移

**Given** 用户从旧版本升级
**When** 首次启动新版本
**Then** 系统应该自动授予所有已安装插件的基础权限
**And** 敏感权限保持"未授予"状态,等待首次使用时请求
