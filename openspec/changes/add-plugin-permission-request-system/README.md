# 插件权限请求系统 - 变更摘要

## 变更 ID
`add-plugin-permission-request-system`

## 概述
为 RokunTool 插件系统添加运行时动态权限请求功能,解决微信分身插件因权限不足导致创建实例失败的问题。

## 问题
微信分身插件创建实例时报错:
```
cp: /Applications/WeChat2.app/WeChat.app: Permission denied
```

**根本原因**:
- 插件声明了 `fs:write` 和 `process:exec` 权限,但这些权限在安装时自动授予
- macOS 系统级权限(写入 `/Applications`)需要用户明确授权
- 缺少运行时权限请求机制

## 解决方案

### 1. 渐进式权限授权
- **基础权限**: 安装时自动授予 (`fs:read`, `config:read`, `notification:show`)
- **敏感权限**: 首次使用时请求用户确认 (`fs:write`, `process:exec`, 等)

### 2. 权限请求对话框
- 显示插件信息、权限说明、操作上下文
- 提供"允许"、"拒绝"、"取消"三个选项
- 友好的错误提示和安全警告

### 3. 权限管理界面
- 在插件详情页面显示权限状态
- 支持查看和撤销已授予的权限
- 显示权限历史记录

### 4. 权限状态持久化
- 保存用户选择到本地存储
- 应用重启后保持权限状态
- 支持随时撤销权限

## 影响范围

### 核心组件
1. **PermissionManager** (新建) - 权限状态管理器
2. **PermissionStore** (新建) - 权限持久化存储
3. **PermissionChecker** (修改) - 集成权限请求逻辑
4. **IPC Handlers** (新增) - 权限相关 IPC 通信

### UI 组件
1. **PermissionRequestDialog** (新建) - 权限请求对话框
2. **PluginDetail** (增强) - 添加权限管理区域
3. **pluginStore** (增强) - 添加权限状态管理

### 插件适配
1. **微信分身插件** (修改) - 处理权限错误
2. **Rime 配置插件** (验证) - 确保兼容性
3. **测试插件** (增强) - 添加权限测试用例

## 实施计划

**总预估**: 16 工作日

### 阶段 1: 核心权限管理器 (3 天)
- 实现 PermissionManager 类
- 实现权限存储
- 集成到 PermissionChecker

### 阶段 2: IPC 通信层 (2 天)
- 实现权限请求 IPC handler
- 增强 preload 脚本

### 阶段 3: 渲染进程 UI (4 天)
- 创建权限请求对话框
- 实现权限状态管理
- 创建权限管理页面

### 阶段 4: 插件适配 (2 天)
- 修改微信分身插件
- 验证其他插件兼容性

### 阶段 5: 测试和文档 (3 天)
- 单元测试、集成测试、UI 测试
- 编写用户和开发者文档

### 阶段 6: 优化和部署 (2 天)
- 性能优化、安全审查
- 用户体验优化
- 发布准备

## 成功标准

1. ✅ 微信分身插件能够成功请求并获得权限
2. ✅ 用户清楚地看到权限请求说明
3. ✅ 权限状态持久化保存
4. ✅ 用户可以管理已授予的权限
5. ✅ 现有插件继续正常工作

## 风险和缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 频繁弹窗打扰用户 | 体验下降 | 同一权限只请求一次 |
| 旧插件不兼容 | 功能中断 | 保持向后兼容 |
| 用户盲目授予权限 | 安全风险 | 显示详细说明和风险提示 |

## 相关文档

- [proposal.md](./proposal.md) - 完整提案
- [design.md](./design.md) - 详细设计
- [tasks.md](./tasks.md) - 实施任务
- [specs/plugin-system/spec.md](./specs/plugin-system/spec.md) - 规范变更

## 快速链接

- **问题**: 微信分身插件权限不足
- **解决方案**: 运行时动态权限请求
- **关键组件**: PermissionManager, PermissionRequestDialog
- **测试重点**: 权限请求流程、状态持久化、UI 交互
