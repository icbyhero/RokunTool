# Proposal: Permanent Deny and Batch Permission Requests

## Change Metadata
- **ID**: `permanent-deny-and-batch-permissions`
- **Title**: 永久拒绝和批量权限请求
- **Status**: `proposed`
- **Created**: 2026-01-13
- **Related Specs**:
  - `spec:plugin-system`
  - `spec:permission-system`

## Problem Statement

当前的权限系统存在以下问题:

1. **缺少永久拒绝选项** - 用户只能选择"拒绝"(会话级)或"永久授权",无法选择"永久拒绝"
2. **权限被拒时缺少反馈** - 当插件尝试使用被拒绝的权限时,没有明确的用户提示
3. **逐个询问权限效率低** - 插件执行一个功能需要多个权限时,会逐个弹出对话框,用户体验不佳

### 具体场景

**场景1: 永久拒绝需求**
用户不希望某个插件永远访问某个权限(如剪贴板),但当前的"拒绝"只在会话期间有效,重启应用后会重置。

**场景2: 权限被拒时的困惑**
用户永久拒绝了插件的剪贴板权限,之后点击插件的"复制"功能,什么都没有发生,用户不知道为什么功能不工作。

**场景3: 批量权限确认**
用户点击"微信分身批量复制"功能,插件需要 `fs:read`、`fs:write`、`clipboard:write` 三个权限,系统连续弹出3个对话框,用户需要点击3次才能完成操作。

## Proposed Solution

### 1. 三选一的权限选项

将当前的对话框从三个选项改为:

- **拒绝** - 仅在本次会话拒绝,下次会话可以重新询问
- **永久拒绝** - 永久拒绝该权限,不会再次询问(除非用户在设置中手动开启)
- **本次授权** - 仅在本次会话授权
- **永久授权** - 永久授予权限

### 2. 权限被拒时的用户通知

当插件尝试使用被永久拒绝的权限时:
- 拒绝执行该操作
- 在右下角显示 Toast 通知
- 通知内容: "插件 {pluginName} 需要的 {permissionName} 权限已被拒绝。请前往设置 > 权限管理中开启。"
- 提供"前往设置"按钮

### 3. 批量权限请求

插件可以一次性请求多个权限:

- 在一个对话框中显示所有需要的权限列表
- 用户一次性确认或拒绝所有权限
- 支持部分授权(用户可以选择只授予某些权限)
- 如果用户拒绝任何一个必需权限,整个操作链中止

## User Impact

### 用户体验改进

1. **更明确的权限控制** - 用户可以明确表达"永远不要"的意图
2. **更好的问题诊断** - 功能不工作时,用户知道是权限问题
3. **更流畅的操作流程** - 批量确认减少点击次数

### 潜在问题

1. **永久拒绝可能导致功能完全不可用** - 需要明确的提示和恢复路径
2. **批量权限可能导致用户不看就全点同意** - 需要清晰的权限说明和风险提示
3. **实现复杂度增加** - 需要修改权限请求API、UI、存储等多个层面

## Implementation Scope

### Phase 1: 永久拒绝功能

**权限系统增强**
- 添加 `PERMANENTLY_DENIED` 权限状态
- 修改 `denyPermission()` 支持 `permanent` 参数
- 修改 `requestPermission()` 检查永久拒绝状态

**UI 更新**
- 将三按钮布局改为四按钮: 拒绝 / 永久拒绝 / 本次授权 / 永久授权
- 更新详细说明文字

**权限恢复**
- 在设置页面添加权限管理功能
- 允许用户查看和修改权限状态
- 支持"重新询问"功能,清除永久拒绝状态

### Phase 2: 权限被拒通知

**通知系统**
- 当检测到永久拒绝的权限被使用时,发送通知事件
- 前端接收事件并显示 Toast 通知
- 提供"前往设置"按钮,跳转到权限管理页面

**IPC 事件**
- 添加 `permission:permanently-denied` 事件
- 包含插件ID、权限类型、操作上下文信息

### Phase 3: 批量权限请求

**API 修改**
- `requestPermission()` 支持传入权限数组
- 返回每个权限的授予结果

**UI 修改**
- 权限请求对话框支持显示权限列表
- 每个权限显示名称、说明、风险等级
- 支持单独切换每个权限的授予/拒绝
- 底部统一确认按钮

**插件集成**
- 插件声明功能时,列出该功能需要的所有权限
- 在调用功能前,统一请求所有权限

## Dependencies

- **无依赖** - 此功能独立于其他功能
- **后续依赖** - 权限管理页面(Phase 1 需要)

## Alternatives Considered

### 方案A: 只添加永久拒绝,不改批量请求

**优点**: 实现简单,改动小
**缺点**: 用户体验改善有限,逐个询问仍然很繁琐

### 方案B: 只做批量请求,不做永久拒绝

**优点**: 立即改善用户体验
**缺点**: 无法满足"永远不要"的需求

### 方案C: 完全不记住拒绝状态

**优点**: 用户可以随时改变主意
**缺点**: 可能导致骚扰弹窗,用户厌烦

**最终选择**: 结合方案A和B,分阶段实现

## Open Questions

1. **批量权限时如何处理必需/可选权限?**
   - 提案: 插件声明时标记权限为 required/optional
   - UI上区分显示,拒绝必需权限时提示用户

2. **永久拒绝后如何恢复?**
   - 提案: 在设置 > 权限管理中提供"重新询问"选项
   - 清除永久拒绝状态,下次请求时重新弹出对话框

3. **批量权限时是否支持部分授权?**
   - 提案: 支持,插件需要检查每个权限是否授予
   - 如果必需权限未授予,插件应中止操作并提示用户

4. **通知的频率控制?**
   - 提案: 同一个(插件,权限)组合,每个会话只通知一次
   - 避免重复通知骚扰用户

## Success Criteria

1. ✅ 用户可以选择永久拒绝某个权限
2. ✅ 永久拒绝后,插件再次请求时不会弹出对话框,直接返回 false
3. ✅ 插件尝试使用被永久拒绝的权限时,右下角显示通知
4. ✅ 用户可以在设置中查看和修改权限状态
5. ✅ 插件可以一次性请求多个权限
6. ✅ 批量权限请求时,用户可以看到所有权限的说明
7. ✅ 用户可以选择部分授权某些权限

## Rollout Plan

### Phase 1 (P0 - 核心功能)
- 永久拒绝状态和UI
- 基础的权限被拒通知

### Phase 2 (P1 - 完整体验)
- 权限管理设置页面
- 批量权限请求

### Phase 3 (P2 - 优化)
- 权限使用历史记录
- 权限建议和风险提示
- 批量权限的高级选项(全部同意/全部拒绝)

## References

- Current implementation: `rokun-tool/src/main/permissions/permission-manager.ts`
- UI component: `rokun-tool/src/renderer/src/components/permissions/PermissionRequestDialog.tsx`
- Related change: `enhance-rime-recipe-market` (权限系统基础)
